# NPC与宗门系统整合更新日志

## 更新时间
2026年1月26日

## 更新概述
本次更新将NPC系统与宗门系统深度整合，让每个攻略NPC都有合理的宗门归属和身份背景，使游戏世界更加动态真实。

---

## 核心功能

### 1. NPC宗门智能分配系统

#### 分配规则
- **基于身份**：根据NPC的身份标签（如"宗门天骄"、"剑修传人"等）自动匹配对应宗门
- **基于资质**：资质必须达到宗门的最低要求（minApt）
- **基于灵根**：优先匹配宗门偏好的灵根元素（如凌霄宗偏好金灵根）
- **智能降级**：资质不足时自动成为散修或进入低级宗门

#### 特殊身份处理
- **神秘不透露**：佛修、妖族半妖、古族遗民等特殊身份不透露宗门
- **散修**：落魄散修、部分凡间书生成为无门无派的独行者
- **叛逃者**：10%概率NPC已经叛出原宗门
- **隐藏身份**：5%概率魔修隐藏真实身份

### 2. NPC宗门状态系统

每个NPC都有以下宗门状态之一：

| 状态 | 说明 | 描述示例 |
|------|------|----------|
| `active` | 在宗 | "现为【凌霄宗】真传弟子" |
| `defected` | 叛出 | "曾是【凌霄宗】外门弟子，后因故叛出宗门" |
| `hidden` | 隐藏身份 | "表面身份是外门弟子，实则隐藏着不可告人的秘密" |
| `mysterious` | 神秘 | "来历神秘，从不透露宗门" |
| `rogue` | 散修 | "独来独往，无门无派" |

### 3. NPC相关的世界事件

#### 个人事件
- **在宗NPC**：宗门大比、突破修为、立功受赏、秘境试炼等
- **真传弟子专属**：被长老收徒、代表宗门出战、获得宗主指点
- **魔道特殊**：走火入魔、屠戮炼功、被正道通缉
- **叛徒事件**：宗门悬赏、追杀令、黑市出没

#### 冲突事件
- 自动检测不同宗门的NPC之间产生冲突
- 生成宗门对立、资源争夺、战斗对决等动态事件

### 4. 动态世界感

- **30%概率**：每月生成与玩家认识的NPC相关的事件
- **事件分类**：新增"熟人动向"类别，让玩家关注的NPC有存在感
- **宗门关联**：宗门事件不再是空洞的背景，而是与具体NPC挂钩

---

## 技术实现

### 修改文件清单

1. **npcGenerator.js**
   - 新增 `assignSectToNpc()` 函数：智能分配宗门
   - 修改 `generateRandomNpc()`：生成时自动分配宗门和职位
   - 新增NPC属性：`sect`, `sectId`, `sectRank`, `sectStatus`

2. **worldEvents.js**
   - 新增 `generateNpcRelatedSectEvent()`：生成单个NPC的宗门事件
   - 新增 `generateNpcSectConflictEvent()`：生成NPC间冲突事件
   - 扩充事件模板：新增20+条NPC相关事件文案

3. **worldEventsSystem.js**
   - 修改 `generateMonthlyWorldEvents()`：接受npcs参数
   - 新增 `generateNpcWorldEvent()`：生成NPC相关世界事件

4. **npcPool.js**
   - 为预设NPC添加宗门信息
   - 陆昭：【凌霄宗】外门弟子（已叛出）
   - 慧空：佛修（神秘不透露）

5. **App.jsx**
   - 传入NPC数据到世界事件生成函数

---

## 游戏体验提升

### 示例场景

#### 场景1：散修的逆袭
```
你遇到了落魄散修"陆昭"
- 身份：曾是【凌霄宗】外门弟子
- 状态：因资质被看轻而离开宗门
- 世界事件：【修仙界震动】凌霄宗通缉叛徒陆昭，悬赏十万灵石
```

#### 场景2：天骄的荣耀
```
你遇到了宗门天骄"云霄"
- 身份：【天帝宗】真传弟子
- 资质：天灵根（雷）95
- 世界事件：【天帝宗】云霄代表宗门出战，击败敌对宗门高手，扬名立万
```

#### 场景3：魔修的隐秘
```
你遇到了魔教护法"血无痕"
- 身份：【天魔教】内门弟子（隐藏身份）
- 状态：表面是正道弟子，实则魔修
- 世界事件：【江湖传闻】有人在暗中调查血无痕的真实身份
```

#### 场景4：佛修的超然
```
你遇到了佛修"慧空"
- 身份：来历神秘，从不透露宗门
- 状态：佛门独立，不问世事
- 世界事件：（不会生成宗门事件）
```

---

## 身份与宗门匹配表

| 身份 | 可能宗门 | 概率 |
|------|----------|------|
| 宗门天骄 | 凌霄宗/天帝宗/天雷宗 | 顶级宗门 |
| 剑修传人 | 凌霄宗 | 100% |
| 丹道奇才 | 丹鼎阁 | 100% |
| 魔教护法 | 天魔教 | 100% |
| 血海魔君 | 血河派 | 100% |
| 器修天才 | 巨石门 | 100% |
| 世家庶子 | 根据资质分配 | 随机 |
| 落魄散修 | 无 | 散修 |
| 佛修 | 无 | 神秘 |
| 妖族半妖 | 无 | 神秘 |

---

## 平衡性调整

### 宗门匹配要求
- **顶级宗门**（凌霄宗、天帝宗）：资质≥80
- **高级宗门**（丹鼎阁、天雷宗）：资质≥60
- **中级宗门**（百花谷、逍遥派）：资质≥40
- **低级宗门**（金刚门、百草谷）：资质≥20
- **魔道宗门**：资质≥30，高风险高收益

### 职位分配概率
- **真传弟子**：资质超门槛20+，灵根匹配，15-20%概率
- **内门弟子**：资质良好，灵根偏好，30-40%概率
- **外门弟子**：达到最低要求，40-50%概率

---

## 未来扩展方向

1. **宗门任务系统**：NPC可以给予玩家宗门相关的任务
2. **宗门声望**：与NPC的关系影响在其宗门的声望
3. **宗门大战**：NPC邀请玩家参与宗门间的战争
4. **叛逃剧情**：帮助叛逃的NPC躲避追杀或劝其回归
5. **双修联盟**：与不同宗门的NPC结成道侣，产生宗门政治影响

---

## 注意事项

### 对现有存档的影响
- 旧存档中的NPC不会自动获得宗门信息
- 新遇到的NPC会自动分配宗门
- 建议在新游戏中体验完整功能

### 性能考虑
- NPC宗门分配在生成时一次性完成，无运行时开销
- 世界事件生成增加轻微计算，但已优化概率分布

---

## 测试建议

1. 新建游戏，遇到多个不同身份的NPC
2. 查看NPC描述，确认宗门信息准确
3. 时间推进多个月，观察"熟人动向"类事件
4. 收集多个不同宗门的NPC，观察冲突事件
5. 测试特殊身份NPC（佛修、妖族）是否正确处理

---

## 总结

本次更新成功将攻略对象与宗门体系深度绑定，让每个NPC都有合理的背景故事和动态发展。世界不再是静态的背景板，而是一个有着复杂人际关系和势力纷争的活跃世界。玩家攻略的不仅是NPC个人，更是在修仙界的权力版图中游走。
