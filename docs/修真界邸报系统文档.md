# 📰 修真界邸报系统文档

## 一、系统概述

《修真界邸报》是一个自动化的游戏事件记录与呈现系统，由"天机阁"发行，每季度（3个月）自动生成一份修真界八卦报纸，记录玩家和NPC的重大事件。

### 核心特性
- ✅ **自动生成**：每3个月自动触发一次
- ✅ **双引擎支持**：AI生成（高配）+ 本地模板（低配）
- ✅ **开关可控**：可在系统设置中开启/关闭
- ✅ **历史回顾**：保存所有历史期号，可随时翻阅
- ✅ **红点提醒**：有新邸报时显示提示
- ✅ **自动降级**：AI失败时自动切换到本地模板

## 二、架构设计

### 2.1 新闻素材池（News Buffer）
游戏中建立了一个全局新闻缓存数组 `player.newsBuffer`，用于收集所有重大事件。

**埋点位置：**
- 玩家突破成功 → `LEVEL_UP`
- NPC突破成功 → `NPC_BREAKTHROUGH`
- NPC突破失败 → `BREAKTHROUGH_FAIL`
- 子嗣出生 → `BIRTH`
- NPC死亡 → `DEATH`
- 子嗣加入宗门 → `JOIN_SECT`

**数据结构：**
```javascript
{
  type: 'LEVEL_UP',  // 事件类型
  data: {            // 事件数据
    actor: '楚清辞',
    detail: '金丹期'
  },
  timestamp: 1234567890
}
```

### 2.2 触发机制
在 `handleNextMonth` 函数中，每当 `nextMonth % 3 === 0` 时触发邸报生成。

**流程：**
1. 检查设置：`localStorage.getItem('enableGazette')`
2. 收集新闻：从 `player.newsBuffer` 获取
3. 生成邸报：调用 `generateGazette()`
4. 显示弹窗：设置 `showGazette = true`
5. 清空缓存：`newsBuffer = []`

### 2.3 双引擎生成策略

#### 引擎A：AI智能生成
**条件：**
- 配置了有效的 API Key
- 设置中启用了"使用AI生成邸报"

**流程：**
1. 将新闻事件转换为自然语言描述
2. 构建Prompt发送给AI模型
3. 解析AI返回的JSON结果
4. 失败时自动降级到本地模板

**Prompt示例：**
```
你是修真界'天机阁'发行的《修真界邸报》主笔...
请根据以下近期发生的事件，生成一份修真界邸报：

近期事件列表：
1. 楚清辞突破至金丹期境界
2. 李四成功突破至筑基期
...

要求：
1. 将最重要的3-5件事放入【头版头条】
2. 其余事件放入【坊间传闻】
3. 语气要惊叹、幽默，符合修真世界观
...
```

#### 引擎B：本地模板拼接
**条件：**
- 未配置API Key
- 或关闭了"使用AI生成"
- 或AI生成失败

**流程：**
1. 从 `newsTemplates.js` 中根据事件类型获取模板
2. 随机选择一条模板
3. 替换占位符 `{actor}`, `{detail}` 等
4. 拼接成完整邸报

**模板示例：**
```javascript
LEVEL_UP: [
  "听闻 {actor} 近日紫气东来，一举突破至【{detail}】，真是恐怖如斯！",
  "{actor} 闭关多日，终成正果，晋升【{detail}】。修真界又多了一位强者。"
]
```

## 三、UI展现

### 3.1 入口按钮
- **位置**：主界面左下角（与时间推进按钮对称）
- **图标**：📰 报纸emoji
- **红点提示**：`player.hasUnreadGazette` 为 true 时显示红点

### 3.2 邸报弹窗
**组件**：`GazetteModal`

**布局：**
```
┌─────────────────────────────┐
│   本期邸报  │  往期回顾      │  ← 顶部Tab切换
├─────────────────────────────┤
│   修真界邸报                 │
│   天机阁发行 · 第X期         │
│   云澜历 3588年 3月          │
├─────────────────────────────┤
│【天机榜 - 本季修为前三】     │
│ 🥇 楚清辞 - 金丹期           │
│ 🥈 李四 - 筑基后期           │
│ 🥉 王五 - 炼气大圆满         │
├─────────────────────────────┤
│【头版头条】                   │
│ · 震惊！楚清辞突破至金丹... │
│ · 听闻李四与圣女喜结连理... │
├─────────────────────────────┤
│【坊间传闻】                   │
│ · 据说某宗长老之子...       │
├─────────────────────────────┤
│【广告位】                     │
│ 🗡️ 天机楼：高价回收二手法宝 │
└─────────────────────────────┘
```

**往期回顾：**
- 显示所有历史邸报的卡片列表
- 点击卡片可查看该期详细内容

## 四、配置选项

### 4.1 系统设置面板
**位置**：底部导航栏 → 系统设置 → 修真界邸报

**选项：**
1. **启用修真界邸报**（默认：开启）
   - 关闭后不再生成邸报，不记录新闻事件
   
2. **使用AI生成邸报**（默认：开启）
   - 需要配置API Key
   - 关闭后使用本地模板（更快但内容固定）

### 4.2 存储位置
- `localStorage.getItem('enableGazette')` - 是否启用
- `localStorage.getItem('useAIForGazette')` - 是否使用AI
- `player.newsBuffer` - 当前季度的新闻缓存
- `player.gazetteHistory` - 历史邸报数组
- `player.gazetteIssue` - 当前期号
- `player.hasUnreadGazette` - 是否有未读邸报

## 五、技术实现

### 5.1 文件结构
```
src/
├── data/
│   └── newsTemplates.js        # 新闻模板库
├── game/
│   └── gazetteSystem.js        # 邸报生成引擎
├── components/
│   └── GazetteModal/
│       └── index.jsx            # 邸报弹窗组件
└── App.jsx                      # 主逻辑（埋点+触发）
```

### 5.2 核心函数

#### `pushToNewsBuffer(newsBuffer, type, data)`
添加事件到新闻缓存
```javascript
pushToNewsBuffer(player.newsBuffer, 'LEVEL_UP', {
  actor: player.name,
  detail: '金丹期'
});
```

#### `generateGazette(newsBuffer, player, npcs, issue, settings)`
生成邸报（自动选择引擎）
```javascript
const gazette = await generateGazette(
  newsBuffer,
  player,
  npcs,
  issue + 1,
  settings
);
```

#### `generateLocalGazette(...)` 
本地模板生成

#### `generateAIGazette(...)`
AI智能生成

#### `generatePowerRanking(npcs, player)`
生成天机榜

### 5.3 数据流
```
游戏事件发生
    ↓
pushToNewsBuffer() 添加到缓存
    ↓
每3个月触发 handleNextMonth
    ↓
检查 enableGazette 设置
    ↓
调用 generateGazette()
    ↓
┌─────────────┬─────────────┐
│  有API Key  │  无API Key  │
│  或AI失败   │  或关闭AI   │
↓             ↓
AI生成        本地模板
    ↓             ↓
    └─────┬───────┘
          ↓
    返回邸报对象
          ↓
    显示弹窗
          ↓
    清空缓存
```

## 六、使用场景

### 场景1：有API配置（高配体验）
1. 在系统设置中配置DeepSeek API Key
2. 启用"使用AI生成邸报"
3. 每季度自动生成AI撰写的幽默八卦新闻
4. 内容更加生动、有趣、符合当前事件

### 场景2：无API配置（离线体验）
1. 不配置API Key，或关闭AI生成
2. 每季度自动使用本地模板
3. 内容简单但不失乐趣
4. 完全离线可用，无需网络

### 场景3：完全关闭
1. 在系统设置中关闭"启用修真界邸报"
2. 游戏不再记录新闻事件
3. 不生成邸报
4. 左下角邸报按钮仍可点击查看历史

## 七、扩展建议

### 7.1 未来功能
- [ ] 邸报内容可分享（生成图片）
- [ ] 添加"点赞最喜欢的新闻"功能
- [ ] NPC也能看到邸报并产生反应
- [ ] 邸报影响NPC好感度
- [ ] 自定义邸报主题/风格

### 7.2 更多新闻类型
- 战斗胜利/失败
- 秘境探险发现
- 产业经营成就
- 子嗣婚配
- 孙辈出生
- 宗门排名变化

### 7.3 AI优化
- 使用更长的上下文窗口
- 记住玩家的喜好风格
- 生成连续的故事线
- 添加NPC八卦关系网络

## 八、常见问题

### Q1: 邸报不生成怎么办？
A: 检查系统设置中是否启用了邸报功能，确保每3个月推进一次时间。

### Q2: AI生成失败会怎样？
A: 系统会自动降级到本地模板，不会影响游戏体验。

### Q3: 如何查看历史邸报？
A: 点击左下角📰按钮，切换到"往期回顾"标签页。

### Q4: 可以删除历史邸报吗？
A: 目前不支持删除，但可以通过删档重置。

### Q5: API调用会消耗多少Token？
A: 每次约消耗500-800 tokens（输入+输出），使用DeepSeek成本约0.001元/次。

## 九、开发指南

### 添加新的新闻类型
1. 在 `newsTemplates.js` 中添加模板
```javascript
export const NEWS_TEMPLATES = {
  YOUR_EVENT_TYPE: [
    "模板1 {actor} ...",
    "模板2 {actor} ..."
  ]
};
```

2. 在事件触发处添加埋点
```javascript
pushToNewsBuffer(player.newsBuffer, 'YOUR_EVENT_TYPE', {
  actor: '张三',
  detail: '详细信息'
});
```

3. 在 `gazetteSystem.js` 的 `formatEventForAI` 中添加AI描述
```javascript
const descriptions = {
  YOUR_EVENT_TYPE: `${data.actor}做了某事${data.detail}`
};
```

### 自定义邸报样式
修改 `GazetteModal/index.jsx` 中的 styles 对象。

---

**版本**：v1.0  
**作者**：游戏开发团队  
**最后更新**：2026年1月27日
