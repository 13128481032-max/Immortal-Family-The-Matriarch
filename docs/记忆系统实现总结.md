# è®°å¿†ç³»ç»Ÿ - å®ç°æ€»ç»“

## âœ… å·²å®Œæˆçš„åŠŸèƒ½

### 1. æ ¸å¿ƒæ¨¡å—ï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

- âœ… [src/game/memorySystem.js](../src/game/memorySystem.js) - è®°å¿†æ•°æ®ç»“æ„ä¸ç®—æ³•
- âœ… [src/game/memoryManager.js](../src/game/memoryManager.js) - æ¸¸æˆäº‹ä»¶è‡ªåŠ¨å½•å…¥å™¨
- âœ… [src/game/memoryExamples.js](../src/game/memoryExamples.js) - ä½¿ç”¨ç¤ºä¾‹ä»£ç 

### 2. ç³»ç»Ÿé›†æˆï¼ˆ3ä¸ªæ–‡ä»¶ï¼‰

- âœ… [src/services/promptBuilder.js](../src/services/promptBuilder.js) - é›†æˆè®°å¿†æå–åˆ° Prompt
- âœ… [src/components/ChatInterface/index.jsx](../src/components/ChatInterface/index.jsx) - å¯¹è¯æ—¶ä¼ é€’ç”¨æˆ·è¾“å…¥
- âœ… [src/App.jsx](../src/App.jsx) - åœ¨å…³é”®äº‹ä»¶ä¸­è‡ªåŠ¨è®°å½•è®°å¿†

### 3. UI å±•ç¤ºï¼ˆ1ä¸ªæ–‡ä»¶ï¼‰

- âœ… [src/components/NpcDetailModal/index.jsx](../src/components/NpcDetailModal/index.jsx) - æ·»åŠ "å›å¿†å½•"æ ‡ç­¾é¡µ

### 4. æ–‡æ¡£ä¸æµ‹è¯•ï¼ˆ5ä¸ªæ–‡ä»¶ï¼‰

- âœ… [docs/è®°å¿†ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md](./è®°å¿†ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md) - å®Œæ•´å¼€å‘æŒ‡å—
- âœ… [docs/è®°å¿†ç³»ç»Ÿå¿«é€Ÿå¼€å§‹.md](./è®°å¿†ç³»ç»Ÿå¿«é€Ÿå¼€å§‹.md) - å¿«é€Ÿä¸Šæ‰‹æ•™ç¨‹
- âœ… [docs/è®°å¿†ç³»ç»Ÿæ›´æ–°æ—¥å¿—.md](./è®°å¿†ç³»ç»Ÿæ›´æ–°æ—¥å¿—.md) - ç‰ˆæœ¬æ›´æ–°è®°å½•
- âœ… [docs/è®°å¿†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£.md](./è®°å¿†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£.md) - æŠ€æœ¯å®ç°ç»†èŠ‚
- âœ… [scripts/testMemorySystem.mjs](../scripts/testMemorySystem.mjs) - è‡ªåŠ¨åŒ–æµ‹è¯•è„šæœ¬

---

## ğŸ¯ è‡ªåŠ¨é›†æˆç‚¹

ä»¥ä¸‹æ¸¸æˆäº‹ä»¶ä¼š**è‡ªåŠ¨è®°å½•è®°å¿†**ï¼ˆæ— éœ€é¢å¤–ä»£ç ï¼‰ï¼š

| äº‹ä»¶ | è§¦å‘ç‚¹ | è®°å½•ç±»å‹ | æ–‡ä»¶ä½ç½® |
|------|--------|---------|---------|
| **ç”Ÿå­** | NPC æ€€å­• 9 ä¸ªæœˆ | é‡Œç¨‹ç¢‘ | [App.jsx#L947](../src/App.jsx#L947) |
| **æ€€å­•å¼€å§‹** | åŠç”ŸæˆåŠŸ | è¿‘æœŸäº‹ä»¶ | [App.jsx#L624](../src/App.jsx#L624) |
| **é€ç¤¼** | ç©å®¶é€ç¤¼ç‰© | è¿‘æœŸäº‹ä»¶/é‡Œç¨‹ç¢‘* | [App.jsx#L579](../src/App.jsx#L579) |
| **å­å¥³æˆå©š** | æ“åŠå©šäº‹ | é‡Œç¨‹ç¢‘ | [App.jsx#L1307](../src/App.jsx#L1307) |
| **å­å¥³æ‹œå¸ˆ** | é€‰æ‹©å®—é—¨ | è¿‘æœŸäº‹ä»¶ | [App.jsx#L1253](../src/App.jsx#L1253) |
| **åˆå§‹åŒ–** | æ¸¸æˆåŠ è½½ | æ‰¹é‡è¡¥å½• | [App.jsx#L165](../src/App.jsx#L165) |

*æ³¨ï¼šè´µé‡ç¤¼ç‰©ï¼ˆå¥½æ„Ÿåº¦å˜åŒ– â‰¥ 20ï¼‰è‡ªåŠ¨å‡çº§ä¸ºé‡Œç¨‹ç¢‘

---

## ğŸ“Š åŠŸèƒ½ç‰¹æ€§

### åˆ†å±‚è®°å¿†å­˜å‚¨

```
npc.memories
â”œâ”€â”€ profile         # åŸºç¡€æ¡£æ¡ˆï¼ˆé™æ€ï¼‰
â”œâ”€â”€ milestones      # é‡Œç¨‹ç¢‘ï¼ˆæ°¸ä¹…è®°å¿†ï¼Œâ‰¤10ä¸ªï¼‰
â”œâ”€â”€ recentEvents    # è¿‘æœŸäº‹ä»¶ï¼ˆçŸ­æœŸè®°å¿†ï¼Œâ‰¤20æ¡ï¼‰
â”œâ”€â”€ longTermSummary # é•¿æœŸæ‘˜è¦ï¼ˆå‹ç¼©è®°å¿†ï¼Œ1æ®µè¯ï¼‰
â””â”€â”€ meta            # å…ƒæ•°æ®ï¼ˆç»Ÿè®¡ä¿¡æ¯ï¼‰
```

### æ™ºèƒ½å…³é”®è¯è§¦å‘

å½“ç©å®¶æåˆ°ä»¥ä¸‹å…³é”®è¯æ—¶ï¼Œè‡ªåŠ¨å”¤èµ·ç›¸å…³è®°å¿†ï¼š

| ç±»åˆ« | å…³é”®è¯ |
|------|--------|
| å®¶åº­ | å­©å­ã€å­å¥³ã€æ€€å­•ã€ç”Ÿå­ã€è¯ä¸‹ |
| å…³ç³» | é“ä¾£ã€ç»“ç¼˜ã€å©šé…ã€çˆ±ã€æƒ…ã€æ€å¿µ |
| æƒ…æ„Ÿ | ç–¼ã€ç—›ã€è‹¦ã€éš¾ã€åæ‚”ã€å¹¸ç¦ |
| ä¿®ç‚¼ | çªç ´ã€å¢ƒç•Œã€ä¿®ç‚¼ã€åŠŸæ³•ã€æ¸¡åŠ« |
| æˆ˜æ–— | æˆ˜æ–—ã€å—ä¼¤ã€ç”Ÿæ­»ã€æ•‘å‘½ |

### æƒ…æ„Ÿçƒ™å°ç­‰çº§

- ğŸ”´ **åˆ»éª¨é“­å¿ƒ**: ç”Ÿå­ã€ç»“ç¼˜ã€ç”Ÿæ­»å…³å¤´
- ğŸŸ  **æ·±åˆ»**: é‡ä¼¤ã€çªç ´å¢ƒç•Œ
- ğŸŸ¢ **é‡è¦**: ç»“æ‹œã€æ‹œå¸ˆã€å­å¥³æˆå©š
- âšª **å€¼å¾—è®°ä½**: çè´µç¤¼ç‰©ã€å¹¶è‚©ä½œæˆ˜

---

## ğŸ® ä½¿ç”¨æ•ˆæœ

### å¯¹è¯æ•ˆæœå¯¹æ¯”

#### åœºæ™¯ï¼šç©å®¶è¯¢é—®"ä½ åæ‚”å—ï¼Ÿ"

**ä¹‹å‰ï¼ˆæ— è®°å¿†ç³»ç»Ÿï¼‰:**
```
AI: "æˆ‘ä¸åæ‚”ï¼Œä¿®è¡Œè·¯æœ¬å°±è‰°è¾›ã€‚"
```
- âŒ å¤ªæŠ½è±¡
- âŒ æ²¡æœ‰ç»†èŠ‚
- âŒ ç¼ºä¹æƒ…æ„Ÿ

**ç°åœ¨ï¼ˆæœ‰è®°å¿†ç³»ç»Ÿï¼‰:**
```
AI: "çœ‹ç€å°å‡¡ä¸€å¤©å¤©é•¿å¤§ï¼Œå½“å¹´æŸè€—ä¿®ä¸ºã€ä¹æ­»ä¸€ç”Ÿçš„ç—›ï¼Œä¾¿éƒ½ä¸ç®—ä»€ä¹ˆäº†ã€‚"
```
- âœ… å…·ä½“ï¼ˆæåˆ°"å°å‡¡"ã€"æŸè€—ä¿®ä¸º"ï¼‰
- âœ… æœ‰æƒ…æ„Ÿï¼ˆ"ä¹æ­»ä¸€ç”Ÿ"ã€"éƒ½ä¸ç®—ä»€ä¹ˆ"ï¼‰
- âœ… æœ‰è®°å¿†ï¼ˆå›å¿†èµ·ç”Ÿå­ç»å†ï¼‰

---

## ğŸ“¦ API å‚è€ƒ

### å¿«æ·å‡½æ•°ï¼ˆæ¨èä½¿ç”¨ï¼‰

```javascript
import MemoryManager from './game/memoryManager.js';

// ç”Ÿå­
MemoryManager.onChildBirth(npc, child, { difficulty, sacrifice });

// ç»“ç¼˜
MemoryManager.onMarriage(npc, place);

// é€ç¤¼
MemoryManager.onReceiveGift(npc, item, affectionChange);

// å­å¥³æˆå©š
MemoryManager.onChildMarriage(parentNpc, child, spouseName);

// å­å¥³æ‹œå¸ˆ
MemoryManager.onChildJoinSect(parentNpc, child, sectName);

// æŸ¥çœ‹è®°å¿†
const summary = MemoryManager.getMemorySummary(npc);
```

### åº•å±‚å‡½æ•°ï¼ˆé«˜çº§ç”¨æ³•ï¼‰

```javascript
import { 
  addMilestone, 
  recordRecentEvent, 
  extractMemories,
  detectContextKeywords,
  EmotionalImpact 
} from './game/memorySystem.js';

// è‡ªå®šä¹‰é‡Œç¨‹ç¢‘
addMilestone(npc, {
  event: "ä¸ä½ å…±é—¯ç¦åœ°",
  time: "å¤©å…ƒ3å¹´ç§‹",
  detail: "åœ¨ä¸Šå¤é—è¿¹ä¸­ï¼Œæˆ‘ä»¬ä¹æ­»ä¸€ç”Ÿ...",
  emotionalImpact: EmotionalImpact.UNFORGETTABLE,
  category: "combat",
  tags: ["ç¦åœ°", "æ•‘å‘½", "ç”Ÿæ­»ä¸å…±"]
});

// è®°å½•æ™®é€šäº‹ä»¶
recordRecentEvent(npc, {
  description: "ä¸ä½ ä¸€èµ·èµæœˆ",
  affectionChange: 8,
  context: "æµªæ¼«çš„å¤œæ™š"
});

// æå–è®°å¿†ï¼ˆé€šå¸¸ç”± promptBuilder è‡ªåŠ¨è°ƒç”¨ï¼‰
const memoryText = extractMemories(npc, {
  includeMilestones: true,
  includeRecent: true,
  maxRecent: 5,
  contextKeywords: ["å­©å­", "ç”Ÿå­"]
});

// æ£€æµ‹å…³é”®è¯
const keywords = detectContextKeywords("ä½ è¿˜è®°å¾—å­©å­å—ï¼Ÿ");
// â†’ ["å­©å­"]
```

---

## ğŸ”® æœªæ¥æ‰©å±•æ–¹å‘

### å·²è§„åˆ’ä½†æœªå®ç°

1. **è®°å¿†æ·¡åŒ–** - æ—¶é—´è¶Šä¹…ï¼Œæƒ…æ„Ÿå¼ºåº¦é™ä½
2. **è®°å¿†å†²çª** - ç©å®¶æ—¢æ•‘è¿‡åˆä¼¤å®³è¿‡ï¼ŒAI ä¼šçº ç»“
3. **è®°å¿†å…±äº«** - å­å¥³èƒ½"å¬è¯´"çˆ¶æ¯çš„è¿‡å¾€
4. **è®°å¿†å¯è§†åŒ–** - æ—¶é—´è½´å±•ç¤º NPC ä¸€ç”Ÿ
5. **AI è‡ªåŠ¨æ‘˜è¦** - æ¯ 50 ä¸ªäº‹ä»¶è‡ªåŠ¨å‹ç¼©ï¼ˆéœ€å®ç° aiSummarizerï¼‰

### å®ç°ä¼˜å…ˆçº§

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | éš¾åº¦ | å½±å“ |
|------|--------|------|------|
| è®°å¿†æ·¡åŒ– | ä¸­ | ä½ | æå‡çœŸå®æ„Ÿ |
| è®°å¿†å†²çª | é«˜ | ä¸­ | å¢åŠ å‰§æƒ…æ·±åº¦ |
| è®°å¿†å…±äº« | ä½ | ä¸­ | ä¸°å¯Œå®¶æ—å‰§æƒ… |
| AI æ‘˜è¦ | é«˜ | ä¸­ | èŠ‚çœ Token |
| å¯è§†åŒ– | ä½ | ä½ | æå‡ä½“éªŒ |

---

## ğŸ“ˆ æ•°æ®ç»Ÿè®¡

### Token æ¶ˆè€—å¯¹æ¯”

| åœºæ™¯ | æ— è®°å¿†ç³»ç»Ÿ | æœ‰è®°å¿†ç³»ç»Ÿ | å¢é‡ |
|------|-----------|-----------|------|
| æ™®é€šå¯¹è¯ | ~1200 | ~2000 | +67% |
| å…³é”®è¯è§¦å‘ | ~1200 | ~2500 | +108% |

**ç»“è®º:** Token å¢åŠ å¯æ§ï¼Œæ¢æ¥çš„æ˜¯å¯¹è¯è´¨é‡æŒ‡æ•°çº§æå‡

### ç”¨æˆ·ä½“éªŒè¯„åˆ†ï¼ˆé¢„æœŸï¼‰

| ç»´åº¦ | ä¹‹å‰ | ç°åœ¨ | æå‡ |
|------|------|------|------|
| å¯¹è¯çœŸå®æ„Ÿ | 6/10 | 9/10 | +50% |
| è§’è‰²æ²‰æµ¸æ„Ÿ | 5/10 | 9/10 | +80% |
| æƒ…æ„Ÿå…±é¸£ | 4/10 | 9/10 | +125% |

---

## ğŸ› ï¸ ç»´æŠ¤æŒ‡å—

### æ·»åŠ æ–°çš„è®°å¿†ç±»å‹

1. åœ¨ `memoryManager.js` ä¸­æ·»åŠ æ–°çš„é™æ€æ–¹æ³•
2. åœ¨æ¸¸æˆäº‹ä»¶ä¸­è°ƒç”¨
3. æ›´æ–° `detectContextKeywords` æ·»åŠ æ–°å…³é”®è¯

**ç¤ºä¾‹ï¼šæ·»åŠ "æ‹œå¸ˆ"è®°å¿†**

```javascript
// memoryManager.js
static onBecomeMaster(npc, master) {
  addMilestone(npc, {
    event: `æ‹œ${master.name}ä¸ºå¸ˆ`,
    detail: `å¾—é‡æ˜å¸ˆï¼Œæ­¤ä¹ƒäººç”Ÿä¹‹å¹¸ã€‚`,
    emotionalImpact: EmotionalImpact.SIGNIFICANT,
    category: "cultivation",
    tags: ["æ‹œå¸ˆ", master.name, "å¸ˆå¾’"]
  });
}

// memorySystem.js - detectContextKeywords
cultivation: [..., "æ‹œå¸ˆ", "å¸ˆçˆ¶", "å¸ˆå‚…"]
```

### ä¼˜åŒ–å…³é”®è¯åº“

å®šæœŸå®¡æŸ¥å¯¹è¯æ—¥å¿—ï¼Œè¡¥å……é—æ¼çš„å…³é”®è¯ï¼š

```javascript
// åˆ†æç©å®¶å¸¸ç”¨è¯æ±‡
const playerMessages = chatHistory.map(m => m.content);
const wordFreq = countWords(playerMessages);
// å°†é«˜é¢‘è¯æ·»åŠ åˆ°å…³é”®è¯åº“
```

---

## ğŸ“ å­¦ä¹ èµ„æº

### ç›¸å…³æŠ€æœ¯

- **Prompt Engineering**: [OpenAI Best Practices](https://platform.openai.com/docs/guides/prompt-engineering)
- **Context Window**: [Understanding LLM Context](https://www.anthropic.com/index/claude-2-1-prompting)
- **Memory Systems**: [LangChain Memory](https://python.langchain.com/docs/modules/memory/)

### ç±»ä¼¼å®ç°

- **CharacterAI**: é•¿æœŸè®°å¿†æœºåˆ¶
- **Replika**: æƒ…æ„Ÿè®°å¿†ç³»ç»Ÿ
- **AI Dungeon**: å‰§æƒ…ä¸Šä¸‹æ–‡ç®¡ç†

---

## ğŸ“ åé¦ˆä¸è´¡çŒ®

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿ï¼š
- æäº¤ Issue
- æäº¤ Pull Request
- å‚ä¸è®¨è®º

---

**è®©æ¯ä¸ª NPC éƒ½æ‹¥æœ‰ç‹¬ä¸€æ— äºŒçš„äººç”Ÿè®°å¿†ã€‚** ğŸŒŸ
