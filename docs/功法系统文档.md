# 功法系统实现文档

## 概述

功法系统为游戏添加了深度的养成策略，玩家需要根据子嗣的灵根属性选择最适合的功法，实现"因材施教"。

## 核心机制

### 1. 功法等级（品阶）

功法分为四个等级，等级决定了修炼速度的基础倍率：

| 品阶 | 基础加成 | 说明 |
|------|---------|------|
| 黄阶 | +20% | 市面流通的大路货，散修常用 |
| 玄阶 | +50% | 普通宗门入门功法 |
| 地阶 | +100% | 大宗门镇派绝学，元婴老怪传承 |
| 天阶 | +200% | 传说中的仙法，可遇不可求 |

### 2. 五行契合度（核心机制）

功法与灵根的契合度决定了功法效果的发挥程度：

#### 契合度系数：

- **完美契合 (1.5倍)**
  - 条件：天灵根/单灵根 且 功法属性完全对应
  - 例如：火系天灵根 + 火系功法
  - 效果：事半功倍，发挥出 150% 的功法效果

- **相生/包含 (1.0倍)**
  - 条件：多灵根中包含功法属性
  - 例如：火木双灵根 + 火系功法
  - 效果：正常发挥

- **相克/不含 (0.5倍)**
  - 条件：灵根中不包含功法属性
  - 例如：水木双灵根 + 火系功法
  - 效果：事倍功半，只能发挥 50% 效果

- **无属性功法 (0.8倍)**
  - 通用功法，所有灵根都能修炼
  - 效果：略打折扣，但胜在适应性强

#### 修炼速度计算公式：

```javascript
最终修炼速度 = 基础速度 * (资质/50) * 灵根倍率 * (1 + 功法等级加成 * 契合度系数) * 词条加成 * 宗门加成
```

### 3. 宗门功法绑定

每个宗门都有自己的招牌功法，子嗣加入宗门后会自动习得：

| 宗门 | 功法 | 属性 | 品阶 |
|------|------|------|------|
| 青云剑宗 | 青云剑诀 | 金 | 玄阶 |
| 丹鼎阁 | 弄焰诀 | 火 | 玄阶 |
| 丹鼎阁（真传）| 九转控火诀 | 火 | 地阶 |
| 合欢宗 | 阴阳和合散 | 无属性 | 玄阶 |
| 天魔教 | 大自在天魔经 | 雷 | 天阶 |

## 文件结构

### 新增文件：

1. **src/data/manualData.js**
   - 功法数据库定义
   - 契合度计算函数
   - 宗门功法配置

2. **src/game/manualSystem.js**
   - 功法系统辅助函数
   - 功法分配和更换逻辑
   - 推荐功法计算

3. **src/components/ChildDetailModal/ManualSection.jsx**
   - 功法信息UI组件
   - 契合度可视化显示

### 修改文件：

1. **src/data/initialPlayer.js**
   - 添加 `cultivationMethod` 字段

2. **src/game/npcGenerator.js**
   - NPC生成时添加默认功法

3. **src/game/mechanics.js**
   - 子嗣生成添加功法字段
   - 导入功法计算函数

4. **src/game/cultivationSystem.js**
   - 新增 `calculateCultivationSpeed()` 函数
   - 新增 `calculateChildFeedback()` 函数（包含功法加成）

5. **src/components/ChildDetailModal/index.jsx**
   - 集成功法信息显示组件

## 使用指南

### 1. 查看子嗣功法

在子嗣详情页面中，会显示：
- 当前修炼的功法名称和等阶
- 功法属性（金木水火土/雷冰风）
- 与子嗣灵根的契合度（完美契合/相性尚可/格格不入）
- 实际修炼加成百分比

### 2. 更换功法

- 点击"🔄 更换功法"按钮
- 系统会显示推荐功法列表（按契合度排序）
- 选择新功法后，修炼速度会相应改变

### 3. 宗门功法获得

- 子嗣在 16 岁时会触发"仙门大选"事件
- 选择宗门后，自动学会该宗门的入门功法
- 部分宗门在晋升真传弟子后可学更高级功法

### 4. 功法获取途径（待实现）

- **宗门**：加入宗门自动获得
- **游历**：随机事件中获得功法秘籍
- **商店**：使用灵石购买低阶功法
- **遗迹**：挑战秘境获得高阶功法
- **传承**：主角可以将自己的功法传授给子嗣

## 策略建议

### 最优组合示例：

1. **火系天灵根 + 九转控火诀（地阶）**
   - 契合度：1.5 倍
   - 功法加成：+100%
   - 实际效果：+150% 修炼速度

2. **雷系变异灵根 + 大自在天魔经（天阶）**
   - 契合度：1.5 倍
   - 功法加成：+200%
   - 实际效果：+300% 修炼速度（爆炸成长）

3. **五灵根 + 五行至尊经（天阶）**
   - 特殊功法，专为五灵根设计
   - 契合度：1.5 倍
   - 将"废柴"变成天才的逆天功法

### 常见错误：

❌ **属性不匹配**
- 水灵根修炼火系功法 → 只有 50% 效果
- 建议：优先选择无属性通用功法（80% 效果）

❌ **盲目追求高阶功法**
- 地阶功法虽强，但如果属性不匹配，还不如玄阶匹配功法
- 计算：地阶不匹配(+50%) < 玄阶匹配(+75%)

## 平衡性调整

### 反哺系统影响：

功法系统也会影响子嗣的反哺效率：
```javascript
反哺 = 境界基础值 * 资质系数 * 职位加成 * 境界衰减 * 功法倍率
```

这意味着：
- 好功法不仅让子嗣修炼更快
- 还能给主角提供更多反哺修为
- 形成正向循环

### 建议：

- 前期重点培养 1-2 个契合度高的天才子嗣
- 为他们寻找最匹配的功法
- 达到筑基期后开始大量反哺

## 后续扩展方向

### 1. 功法物品化
- 功法可以作为物品存在于背包中
- 玩家需要先获得功法秘籍，才能传授给子嗣

### 2. 功法等级系统
- 功法可以升级（小成、大成、圆满）
- 不同熟练度有不同效果

### 3. 功法冲突
- 修炼相克属性功法会走火入魔
- 需要"废功重修"才能切换属性

### 4. 双修/组合功法
- 特定功法组合有额外加成
- 例如：夫妻双修同一功法速度翻倍

## 技术接口

### 主要函数：

```javascript
// 计算契合度
calculateCompatibility(manualId, spiritRoot)

// 计算修炼速度
calculateCultivationSpeed(character, isMonthly)

// 计算反哺
calculateChildFeedback(child)

// 分配宗门功法
assignSectManual(child, sectName)

// 更换功法
changeManual(child, manualId)

// 获取推荐功法
getRecommendedManuals(spiritRoot, availableManuals)
```

## 测试建议

1. **契合度测试**
   - 创建不同灵根的子嗣
   - 尝试不同功法
   - 观察修炼速度变化

2. **宗门功法测试**
   - 让子嗣加入不同宗门
   - 检查是否正确获得对应功法
   - 验证功法效果

3. **极端情况测试**
   - 五灵根 + 天阶功法
   - 天灵根 + 不匹配功法
   - 验证数值计算正确性

## 已知问题

1. **功法更换界面** 
   - 目前只有按钮，完整的选择界面需要在 App.jsx 中实现
   
2. **功法获取途径**
   - 除了宗门自动获得外，其他获取方式待实现
   
3. **功法秘籍物品**
   - 功法暂时直接修改数据，物品化系统待开发

## 总结

功法系统通过引入"契合度"机制，解决了灵根系统中"好坏只是数值差异"的问题。现在玩家需要：

1. 根据灵根选择匹配的功法（策略性）
2. 权衡功法品阶与契合度（取舍）
3. 利用宗门资源获取特定功法（目标导向）

这让游戏的养成玩法更有深度，也增加了可玩性。
