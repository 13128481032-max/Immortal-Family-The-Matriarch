# NPC 日志系统 v2.0 完整版更新日志

## 版本：v2.0.0 - 完整生命周期版
**更新日期**：2026年1月26日

---

## 🎉 重大更新概览

在 v1.0 的基础上，v2.0 增加了完整的 NPC 生命周期系统，让 NPC 真正"活"起来！

---

## ✨ 新增核心功能

### 1. 📖 日志查看门槛（30 好感度）

**变更原因**：增加游戏挑战性和沉浸感

**具体实现**：
- 好感度 < 30：无法查看任何日志，显示"关系不足"提示
- 好感度 30-79：可以查看普通日志
- 好感度 80+：可以查看所有日志（包括私密）

**影响**：
- 玩家需要先与 NPC 建立基础关系
- 增强了日志的"偷窥感"和获得成就感

---

### 2. ⚔️ 切磋系统

**功能描述**：与 NPC 进行友好切磋，提升修为和关系

**条件限制**：
- 关系状态不能是敌对（好感度 >= 0）
- 敌对状态提示"只能生死搏杀，无法切磋"

**游戏机制**：
- 使用战斗引擎模拟切磋过程
- 友好切磋，双方不会死亡
- 胜利奖励：+3 经验，+3 好感
- 失败奖励：+5 经验，+5 好感
  - 设计理念：输了反而学到更多（谦逊学习）

**日志生成**：
- 胜利日志：NPC 认可玩家实力、心服口服
- 失败日志：NPC 不甘心、决心变强、心跳加速（暗恋）

**示例日志**：
```
[胜利] 今日与{玩家}切磋，我略胜一筹。{性别}的身法确实独特，值得我深思。
[失败] 败在{玩家}手下，虽不甘心，但...确实痛快！{性别}那一招我从未见过。
```

**UI 位置**：
- NPC 卡片上的"⚔️ 切磋"按钮
- 敌对状态时按钮禁用

---

### 3. 🧘 双修系统

**功能描述**：与亲密 NPC 共修大道，大幅提升修为

**条件限制**：
- 亲密关系（好感度 >= 80）
- 低于 80 提示"需要亲密关系才能双修"

**消耗与收益**：
- 消耗：50 灵石（布置阵法）
- 玩家收益：+20 经验，+5 好感
- NPC 收益：+20 经验，+5 好感
- 双方共同提升修为

**日志生成**：
- 自动标记为**私密日志**（🔒）
- 需要 80+ 好感才能查看
- 内容亲密且私密

**示例日志**：
```
今夜与{玩家}双修，感觉灵气在经脉中流转顺畅，{性别}的真元竟与我如此契合...
```

**特殊意义**：
- 这是最亲密的互动方式
- 体现道侣之间的深厚关系
- 修炼效率远超独自修炼

**UI 位置**：
- NPC 卡片上的"🧘 双修"按钮
- 好感度 < 80 时按钮禁用

---

### 4. 💀 NPC 寿元系统

**系统设计**：模拟 NPC 的生老病死

#### 核心机制：

**年龄增长**：
- 每年（12 个月）增长 1 岁
- 年龄在 NPC 详情中显示

**寿元计算**：
```
剩余寿元 = 基础寿元 - 当前年龄
```

**寿元状态**：
- 充足（> 30年）：绿色显示
- 告警（10-30年）：橙色显示
- 危险（< 10年）：红色显示 + ⚠️ 提示

**临终日志**：
- 剩余寿元 < 10 年时，自动生成临终日志
- 只生成一次，避免重复

**示例临终日志**：
```
近日总感气血衰败，大限将至了吗...还有好多事没做完。
若真的大限将至，我还有什么放不下的呢？{玩家}的面容浮现在脑海，或许...这就是羁绊吧。
```

**死亡机制**：
- 寿元耗尽（剩余 <= 0）：NPC 坐化
- 死亡后标记 `isDead: true`
- 不再参与互动和日志生成
- 记录死亡事件到游戏日志

**延寿方法**：
- 帮助 NPC 突破境界
- 境界越高，基础寿元越长
- 双修可以加速 NPC 修炼

**UI 显示**：
- NPC 详情中增加"⏳ 生命状态"面板
- 显示当前年龄、基础寿元、剩余寿元
- 寿元不足时显示红色警告

---

### 5. ⚡ NPC 自动修为推进

**系统设计**：NPC 会自己修炼，不再是静态数据

#### 核心机制：

**自动修炼**：
- 每月有 **20% 概率**进行修炼
- 避免所有 NPC 同时突破（太快）

**经验获取**：
```
基础经验 = 1-5 点（随机）
资质加成 = 资质 / 20
灵根加成 = 灵根倍率 × 3
总经验 = 基础 + 资质加成 + 灵根加成
```

**突破判定**：
- 经验 >= 当前境界上限：尝试突破
- 不满足：继续积累

**突破成功率**：
```
基础成功率 = 30%
资质加成 = (资质 / 10) × 5%
灵根加成 = 灵根倍率 × 30%
最终成功率 = 10% ~ 90%（限制范围）
```

**突破成功**：
- 提升到下一境界
- 重置经验为 0
- 提升战斗属性（生命、攻击、防御）
- 生成突破成功日志

**突破失败**：
- 损失 30% 当前经验
- 生成突破失败日志
- 可以再次尝试

**示例日志**：
```
[成功] 闭关三月，终于冲破瓶颈，踏入{新境界}！天道酬勤，我的努力没有白费！
[失败] 该死！明明只差一线，为何灵气突然逆流？咳咳...看来又要修养数月了。
```

**事件记录**：
- 突破成功：记录到游戏日志"⚡ XX 成功突破至 XX！"
- 玩家可以看到 NPC 的成长轨迹

**UI 显示**：
- NPC 详情中增加"⚡ 修为进度"面板
- 显示当前境界、经验进度条
- 实时反映 NPC 的修炼状态

---

### 6. 🤝 关系状态系统

**系统设计**：根据好感度自动判定关系，影响互动

#### 关系分类：

| 状态 | 好感度范围 | 图标 | 颜色 | 特点 |
|------|-----------|------|------|------|
| **敌对** | < 0 | ⚔️ | 红色 | 无法赠礼、切磋 |
| **中立** | 0-49 | 🤝 | 灰色 | 正常互动 |
| **友好** | 50-79 | 😊 | 绿色 | 互动效果更好 |
| **亲密** | 80+ | 💖 | 粉色 | 解锁双修、劝生 |

#### 互动限制：

**敌对状态**：
- ❌ 无法赠礼：提示"敌对状态无法赠礼"
- ❌ 无法切磋：提示"敌对状态只能生死搏杀，无法切磋"
- ✅ 可以聊天：但可能减少好感度

**中立状态**：
- ✅ 所有基础互动都可用

**友好状态**：
- ✅ 互动效果更好
- ✅ 更容易触发特殊剧情

**亲密状态**：
- ✅ 解锁双修
- ✅ 解锁劝生
- ✅ 可以查看所有私密日志

#### UI 显示：

**NPC 卡片**：
- 按钮根据关系状态自动禁用/启用
- 禁用时显示灰色，悬浮提示原因

**NPC 详情**：
- 在"❤️ 情感状态"面板中显示关系标签
- 用颜色和图标直观展示
- 例：💖 亲密（粉色）

---

## 🔄 系统集成

### 时间推进集成

在每月推进（`handleNextMonth`）时：

1. **处理 NPC 生命周期**：
   - 每年增长 1 岁
   - 检查寿元状态
   - 生成临终日志
   - 处理死亡

2. **处理 NPC 修炼**：
   - 20% 概率获得经验
   - 尝试突破境界
   - 生成突破日志

3. **生成月度日志**：
   - 为所有活跃 NPC 生成日常日志
   - 排除已死亡的 NPC

4. **记录重要事件**：
   - 死亡事件："💀 XX 寿元耗尽，坐化而逝。"
   - 突破事件："⚡ XX 成功突破至 XX！"

---

## 📊 数据结构变更

### NPC 对象新增字段：

```javascript
{
  // === 原有字段 ===
  id: 1,
  name: "陆昭",
  age: 25,
  relationship: { affection: 0, trust: 0 },
  logs: [],
  
  // === v2.0 新增 ===
  
  // 修为相关
  tier: "炼气三层",
  currentExp: 15,      // 当前经验
  maxExp: 100,         // 本境界所需经验
  
  // 生命状态
  isDead: false,       // 是否死亡
  deathReason: null,   // 死亡原因
  
  // 内部标记
  _nearDeathLogged: false,  // 是否已记录临终日志
  _hasLogThisMonth: false   // 本月是否已有日志
}
```

---

## 🎨 UI 改进

### NPC 卡片：

**按钮布局**：
- 从 2 列改为 3 列网格
- 新增"⚔️ 切磋"和"🧘 双修"按钮
- 按钮根据关系状态自动禁用

**按钮颜色**：
- 切磋：橙色 (#ff9800)
- 双修：紫色 (#9c27b0)
- 劝生：粉色 (#d81b60)

### NPC 详情：

**新增面板**：
1. **⏳ 生命状态**：
   - 当前年龄、基础寿元、剩余寿元
   - 寿元不足时红色警告

2. **⚡ 修为进度**：
   - 当前境界
   - 经验进度条
   - 数值显示

3. **关系状态标签**：
   - 在情感面板中显示
   - 彩色标签 + 图标

### 日志查看：

**30 好感门槛界面**：
- 显示大锁图标（🔒）
- 提示"关系不足"
- 显示当前好感度和所需好感度（X / 30）
- 引导玩家提升关系

---

## 📝 新增日志模板

### 寿元相关（5 条）：
```javascript
"近日总感气血衰败，大限将至了吗...还有好多事没做完。"
"手脚越来越不听使唤，修为也在衰退。我的时间不多了。"
"今日对镜梳妆，竟发现鬓角已全白。岁月不饶人啊..."
"感觉到寿元在流失，每一次呼吸都比以前更加吃力。我还能坚持多久？"
"若真的大限将至，我还有什么放不下的呢？{玩家}的面容浮现在脑海，或许...这就是羁绊吧。"
```

### 突破成功（5 条）：
```javascript
"闭关三月，终于冲破瓶颈，踏入{新境界}！天道酬勤，我的努力没有白费！"
"今日突破成功，迈入{新境界}！感受到体内灵力奔涌，仿佛脱胎换骨一般。"
"终于突破了！{新境界}的境界果然不同凡响，我能感受到天地灵气的流动更加清晰了。"
"苦修数载，今日终成{新境界}！回想起当初的艰辛，一切都值得了。"
"突破的那一刻，雷劫降临，我硬抗下来了！如今已是{新境界}，距离那个目标又近了一步。"
```

### 突破失败（4 条）：
```javascript
"该死！明明只差一线，为何灵气突然逆流？咳咳...看来又要修养数月了。"
"尝试突破失败，经脉受损。这次失败让我明白，修炼不可急躁。"
"突破失败，心魔反噬...我差点走火入魔。看来我的道心还不够坚定。"
"冲击{目标境界}失败，灵力在关键时刻紊乱。或许是我准备不足，需要更多时间沉淀。"
```

---

## 🎯 游戏平衡性调整

### 经验获取速度：

**玩家**：
- 基础：5 点/月
- 切磋胜利：+3
- 切磋失败：+5
- 双修：+20
- 子女反哺：视子女修为

**NPC**：
- 自动修炼：1-10 点/月（概率）
- 双修：+20
- 切磋：不增加（只记录日志）

### 突破难度：

**玩家**：
- 手动突破，可选择时机
- 需要消耗资源（灵石、丹药等）

**NPC**：
- 自动尝试突破
- 成功率受资质和灵根影响
- 失败有惩罚（损失经验）

### 寿元平衡：

**基础寿元**：
- 凡人：80-100 年
- 炼气：100-120 年
- 筑基：150-200 年
- 金丹：300-500 年
- 更高境界：更长寿元

**延寿机制**：
- 每提升一个大境界，基础寿元增加
- 特殊体质可能影响寿元
- 丹药可以短暂延寿（未实现）

---

## 🐛 已知问题与注意事项

### 1. 性能考虑

**问题**：
- 每月为所有 NPC 处理生命周期
- NPC 数量过多时可能有延迟

**解决方案**：
- 控制活跃 NPC 数量在 50 以内
- 死亡的 NPC 自动排除处理

### 2. 存档兼容性

**旧存档加载**：
- 自动为 NPC 初始化新字段
- `currentExp`、`maxExp` 默认为 0 和 100
- `isDead` 默认为 false

**建议**：
- 重要存档升级前备份
- 或者开始新游戏体验完整功能

### 3. 突破速度

**可能问题**：
- 高资质 NPC 突破太快
- 低资质 NPC 永远无法突破

**平衡调整**：
- 每月 20% 修炼概率（已限制）
- 突破成功率 10%-90%（已限制）
- 可以通过双修帮助 NPC 加速

### 4. 死亡处理

**当前实现**：
- 死亡的 NPC 仍保留在列表中
- 标记为 `isDead`
- 不参与互动

**未来优化**：
- 死亡 NPC 移入"逝者名录"
- 可以查看生前日志
- 墓碑系统（待实现）

---

## 💡 游戏策略建议

### 1. 培养核心 NPC

**选择标准**：
- 高资质（80+）：突破快，寿命长
- 好灵根（单灵根、天灵根）：修炼快
- 喜欢的性格：互动更有趣

**培养方式**：
- 频繁双修：快速提升修为
- 赠送喜好礼物：提升好感解锁功能
- 定期切磋：增进关系

### 2. 延缓 NPC 死亡

**方法**：
- 尽早培养关系，解锁双修
- 帮助 NPC 突破境界延寿
- 关注寿元警告，及时干预

### 3. 记录重要时刻

**值得关注的日志**：
- 首次双修日志（私密）
- 临终日志（珍贵回忆）
- 突破成功日志（成长见证）
- 暗恋日志（感人瞬间）

### 4. 关系管理

**避免敌对**：
- 不要送讨厌的礼物
- 不要在剧情中选择冒犯选项
- 敌对后很难挽回

**快速提升好感**：
- 切磋（失败反而加得多）
- 双修（+5/次）
- 赠送喜好礼物
- 触发特殊剧情

---

## 🎬 示例场景

### 场景 1：见证 NPC 成长

**第 1 年**：
```
陆昭（炼气三层）- 经验 15/100
日志：今日练剑三千次，心神不宁...
```

**第 3 年**：
```
陆昭（炼气六层）- 经验 82/150
日志：终于突破了！炼气六层的境界果然不同凡响...
```

**第 5 年**：
```
陆昭（筑基初期）- 经验 5/200
日志：闭关三月，终于冲破瓶颈，踏入筑基期！天道酬勤！
```

### 场景 2：抢救临终 NPC

**发现**：
```
查看陆昭详情 → ⚠️ 剩余寿元: 8 年（红色警告）
日志：近日总感气血衰败，大限将至了吗...
```

**行动**：
```
1. 疯狂双修（每月 +20 经验）
2. 3 个月后经验满 → 突破成功！
3. 寿元延长 50 年
```

**结果**：
```
陆昭（金丹初期）- 剩余寿元: 58 年（绿色安全）
日志：突破的那一刻，雷劫降临，我硬抗下来了！多亏了{玩家}的帮助...
```

### 场景 3：关系从敌对到亲密

**初始**：
```
楚清瑶 - 好感度: -20（敌对 ⚔️）
无法赠礼、无法切磋
```

**转变**：
```
1. 频繁闲聊（每次 +2）
2. 好感度 0 → 解锁切磋
3. 切磋失败（+5 好感）
4. 好感度 30 → 解锁日志查看
5. 持续互动...
6. 好感度 80 → 亲密关系 💖
```

**结果**：
```
解锁双修、劝生
查看所有私密日志
日志：偷偷去看了{玩家}一眼...（病娇日志）
```

---

## 📈 数据统计

### 新增代码量：

- `npcLifecycle.js`: 400+ 行
- 修改 `npcLogSystem.js`: 20 行
- 修改 `NpcLogModal.jsx`: 30 行
- 修改 `App.jsx`: 150 行
- 修改 `NpcCard/index.jsx`: 50 行
- 修改 `NpcDetailModal/index.jsx`: 80 行

**总计**：约 730 行新增/修改代码

### 新增模板数量：

- 寿元日志：5 条
- 突破成功日志：5 条
- 突破失败日志：4 条

**总计**：14 条新模板

---

## 🔮 未来规划

### 短期（v2.1）：
- [ ] NPC 之间的互动（朋友、仇人）
- [ ] 墓碑系统（纪念逝去的 NPC）
- [ ] 更多延寿方法（丹药、法宝）

### 中期（v2.5）：
- [ ] NPC 自动触发事件（主动找玩家）
- [ ] NPC 结婚系统（与其他 NPC）
- [ ] 师徒系统（传承功法）

### 长期（v3.0）：
- [ ] NPC 后代系统
- [ ] 宗门势力系统
- [ ] 世代传承玩法

---

## 🙏 致谢

感谢所有提供反馈和建议的玩家！

特别感谢对"寿元系统"和"NPC 成长"的需求提出，这让游戏更加真实和感人。

---

**版本：v2.0.0 | 最后更新：2026年1月26日**

**让每个 NPC 都成为有血有肉、会生老病死的"活人"！** 🌟
