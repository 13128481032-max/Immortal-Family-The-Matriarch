# 记忆系统与日志系统说明

## 🎯 为什么要移除前端回忆录展示？

在实现记忆系统后，我们发现它与游戏已有的**NPC 日志系统**功能存在重叠，容易造成混淆。为了保持系统职责清晰、界面简洁，我们做出了以下调整：

---

## 📋 两个系统的定位

### 🧠 记忆系统（Memory Palace）

**核心目标：** 为 AI 对话提供智能上下文

**运行方式：** 后台运行，不直接展示给玩家

**数据结构：**
- 里程碑（Milestones）：永久记忆，结构化存储
- 近期事件（Recent Events）：短期记忆，FIFO 队列
- 长期摘要（Long-term Summary）：AI 自动压缩的概述

**触发机制：**
- 关键词检测（"孩子"、"后悔"、"痛"等）
- 自动注入到 System Prompt
- 根据对话内容动态提取相关记忆

**设计理念：**
```
游戏事件 → 记忆系统记录 → 对话时注入 → AI 生成情感化回复
```

**示例场景：**
```
玩家问："你后悔吗？"
↓
系统检测关键词 "后悔"
↓
提取记忆：生子时难产、损耗修为
↓
注入到 Prompt：
  "你曾为他诞下孩子，历经难产，甚至损耗修为。
   但看着孩儿长大，你从未后悔..."
↓
AI 回复：
  "看着小凡一天天长大，当年的痛都不算什么了。"
```

---

### 📖 日志系统（NPC Logs）

**核心目标：** 让玩家窥探 NPC 的内心世界

**运行方式：** 前端界面展示，第一人称日记形式

**数据结构：**
- 互动日志（闲聊、赠礼、切磋）
- 重大事件（突破、结婚、生子）
- 日常记录（修炼、社交、探险）
- 私密日志（暗恋、双修、内心挣扎）

**查看门槛：**
- 基础日志：好感度 30+
- 私密日志：好感度 80+

**设计理念：**
```
游戏事件 → 日志系统记录 → 玩家查看 → 了解 NPC 生活轨迹
```

**示例场景：**
```
玩家查看陆昭的日志：

━━━━━━━━━━━━━━━━━━━━━━
天元5年春
━━━━━━━━━━━━━━━━━━━━━━

⚡ 重大事件
为你诞下一子，取名张小凡。
那撕心裂肺的痛，我这辈子都忘不了...
但看着他那双眼睛，一切都值得了。

💬 互动记录
你今日送我一枚聚灵丹，说是为我补养身子。
心中甚是感激，却又不知如何言说...

📖 日常记录
今日修炼有所进境，虽损耗修为，
但灵力运转较往日顺畅了些。
```

---

## 🔄 调整后的架构

### 记忆系统（后端）

**文件位置：**
- `src/game/memorySystem.js` - 核心数据结构
- `src/game/memoryManager.js` - 记忆录入 API
- `src/services/promptBuilder.js` - 上下文注入

**运行时机：**
- 游戏事件发生时自动记录
- 对话时自动提取和注入
- 玩家不直接感知

**API 使用示例：**
```javascript
// 在生子时自动记录
MemoryManager.onChildBirth(npc, child, {
  difficulty: "难产",
  sacrifice: true
});

// 在对话时自动提取
const memories = extractMemories(npc, {
  keywords: ["孩子", "后悔"],
  maxMilestones: 5
});
```

### 日志系统（前端）

**文件位置：**
- `src/game/npcLogSystem.js` - 日志生成逻辑
- `src/components/Modals/NpcLogModal.jsx` - 日志查看界面
- `src/data/logTemplates.js` - 日志模板库

**查看入口：**
```
点击 NPC 详情页 
↓
滚动到底部 
↓
点击"📖 查看XX的日志"按钮
↓
查看第一人称日记
```

**界面功能：**
- 📚 全部 - 显示所有日志
- 💬 互动 - 只显示与玩家的互动
- ⚡ 大事 - 重大事件
- 📖 日常 - 日常生活记录
- 🔒 私密 - 需 80+ 好感度

---

## 🎯 两个系统的协同

虽然它们各司其职，但可以相互补充：

### 协同场景 1：生子事件

**事件发生：**
```
陆昭为玩家诞下孩子（天元5年春）
```

**记忆系统记录：**（后台）
```javascript
{
  event: "为你生子",
  detail: "为你诞下张小凡，历经难产，甚至损耗修为...",
  emotionalImpact: "刻骨铭心",
  tags: ["生子", "孩子", "张小凡", "难产", "牺牲"]
}
```

**日志系统记录：**（前端）
```
[天元5年春 - 重大事件]
为你诞下一子，取名张小凡。
那撕心裂肺的痛，我这辈子都忘不了...
但看着他那双眼睛，一切都值得了。
```

**玩家体验：**
1. 查看日志 → 了解 NPC 内心感受（第一人称日记）
2. 与 NPC 对话 → AI 回忆起这段往事（情感化对话）

### 协同场景 2：送礼

**事件发生：**
```
玩家赠送聚灵丹（价值 500 灵石，+25 好感）
```

**记忆系统记录：**（后台）
```javascript
{
  event: "收到珍贵礼物：聚灵丹",
  emotionalImpact: "刻骨铭心", // 因为好感度 +25
  affectionChange: 25
}
```

**日志系统记录：**（前端）
```
[天元5年夏 - 互动记录]
你今日送我一枚聚灵丹，说是为我补养身子。
这等贵重之物，我本不敢收...
但见你眼中真诚，便收下了。心中甚是感激。
```

**对话效果：**
```
玩家问："还记得我送你的聚灵丹吗？"
AI 回复："怎么会忘？那是我收到过最珍贵的礼物，
         每次服用时都能想起你当时的眼神..."
```

---

## 📊 数据对比

| 特性           | 记忆系统           | 日志系统           |
| -------------- | ------------------ | ------------------ |
| **定位**       | AI 对话上下文      | 玩家窥探工具       |
| **展示方式**   | 不直接展示         | 前端界面展示       |
| **文体风格**   | 结构化数据         | 第一人称日记       |
| **查看门槛**   | 无（自动运行）     | 好感度 30+         |
| **存储容量**   | ~10 里程碑 + 20 事件 | 最近 50 条日志    |
| **更新频率**   | 每个重要事件       | 每个游戏事件       |
| **Token 消耗** | ~2350 tokens/对话  | 不消耗 Token       |
| **AI 可见**    | ✅ 注入到 Prompt   | ❌ 不注入          |
| **玩家可见**   | ❌ 后台运行        | ✅ 界面展示        |

---

## 🎨 用户体验流程

### 流程 1：了解 NPC 生活

```
玩家想了解 NPC 这段时间发生了什么
↓
点击 NPC 详情页
↓
点击"📖 查看XX的日志"
↓
阅读第一人称日记
↓
了解 NPC 的内心想法和生活轨迹
```

### 流程 2：情感化对话

```
玩家想和 NPC 聊聊过去
↓
点击 NPC 详情页
↓
选择"💬 传音对话"
↓
输入："还记得当年生孩子的事吗？"
↓
记忆系统检测关键词 "孩子"、"生"
↓
自动提取相关里程碑记忆
↓
AI 生成情感化回复：
  "何止是记得...那种撕心裂肺的痛，
   我这辈子都忘不了。但看着小凡一天天长大，
   我从未后悔过..."
```

---

## 🔧 技术实现

### 记忆系统的关键代码

**1. 自动记录（App.jsx）**
```javascript
// 在生子事件中
MemoryManager.onChildBirth(parent, child, {
  difficulty: Math.random() > 0.7 ? "难产" : "顺利",
  sacrifice: Math.random() > 0.85
});
```

**2. 对话时注入（promptBuilder.js）**
```javascript
// 检测关键词
const keywords = detectContextKeywords(userMessage);

// 提取相关记忆
const memories = extractMemories(npc, {
  keywords: keywords.all,
  maxMilestones: 5,
  includeRecent: true
});

// 注入到 System Prompt
if (memories.milestones.length > 0) {
  systemPrompt += `\n\n## 你的记忆\n${memories.formattedText}`;
}
```

### 日志系统的关键代码

**1. 自动记录（npcLogSystem.js）**
```javascript
// 生成第一人称日志
const logContent = fillTemplate(
  maleBirthTemplates.success,
  npc,
  player,
  { childName, difficulty: "难产" }
);

// 添加到 NPC 日志
addNpcLog(npc, year, month, logContent, LOG_TYPE.STATE_CHANGE, false);
```

**2. 前端展示（NpcLogModal.jsx）**
```javascript
// 根据好感度过滤可见日志
const visibleLogs = getVisibleLogs(npc, playerAffection);

// 渲染日志列表
{visibleLogs.map(log => (
  <div className="log-entry">
    <div className="log-time">{log.year}年{getSeasonName(log.month)}</div>
    <div className="log-content">{log.content}</div>
  </div>
))}
```

---

## ✅ 总结

### 记忆系统的价值

- ✅ 让 AI 对话更有深度和情感
- ✅ 根据玩家问题动态调整上下文
- ✅ 不占用界面空间，后台默默工作
- ✅ 自动化程度高，零维护成本

### 日志系统的价值

- ✅ 让玩家了解 NPC 的内心世界
- ✅ 第一人称日记形式更有代入感
- ✅ 好感度门槛增加游戏深度
- ✅ 独立的界面展示，信息完整

### 两个系统的协同

- ✅ 记忆系统 = AI 的"大脑"（后台数据支撑）
- ✅ 日志系统 = 玩家的"窗口"（前端信息展示）
- ✅ 各司其职，互不冲突
- ✅ 共同打造有血有肉的 NPC

---

## 🚀 未来展望

### 可能的增强功能

1. **记忆融合**：将日志内容自动转换为记忆数据（避免重复录入）
2. **记忆可视化**：开发者模式下可查看记忆系统的内部状态
3. **记忆冲突检测**：当 NPC 对玩家既有救命之恩又有伤害之痛时，AI 如何处理矛盾
4. **记忆共享**：子女可以听父母讲述往事（跨 NPC 的记忆传递）

### 当前状态

- ✅ 记忆系统：v1.0.1（后台运行）
- ✅ 日志系统：v2.0（前端完善）
- ✅ 职责清晰，功能互补
- ✅ 生产环境就绪

---

**最后提醒：** 如果你想查看 NPC 的生活记录，请使用"📖 查看XX的日志"功能；如果你想和 NPC 进行深度对话，记忆系统会在后台自动为你提供上下文支持！🎭
