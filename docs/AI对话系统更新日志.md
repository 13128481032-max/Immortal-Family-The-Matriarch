# AI 对话功能更新日志

## 版本 1.1.0 (2026-01-25)

### 🎮 重大更新：游戏状态智能集成

AI 现在可以实时读取游戏状态，让对话更加真实和连贯！

---

### ✨ 新增功能

#### 1. 游戏状态感知系统
- 📡 **文件**：`src/services/promptBuilder.js`
- **功能**：
  - ✅ **子女识别**：AI知道你们共同养育的孩子
    - 自动匹配通过 `fatherName`、`motherId`、`parentId` 等字段
    - 显示子女的名字、年龄、修为境界
    - 了解子女是否拜入宗门、已婚配
    - 知晓子女的特殊天赋词条
  - ✅ **道侣关系**：检测是否已结为道侣（好感度≥90 或关系阶段≥3）
  - ✅ **怀孕状态**：感知NPC怀孕及进度（显示月数）
  - ✅ **关系阶段**：识别是否已见家长等重要里程碑
  - ✅ **事件历史**：支持记录和引用重要互动历史（待实现）

#### 2. Prompt 增强
- 🎭 **文件**：`src/services/promptBuilder.js`
- **改进**：
  - 新增 `gameState` 参数传递游戏状态
  - 动态构建【你们的关系】上下文
  - 自然融入子女信息到人设中
  - 引导AI在合适时提及家庭
  - 所有 Prompt 构建函数统一支持 gameState

#### 3. 组件数据流升级
- 💬 **文件**：
  - `src/components/ChatInterface/index.jsx` - 接收 gameState prop
  - `src/components/NpcDetailModal/index.jsx` - 构建并传递 gameState
  - `src/App.jsx` - 向下传递 children 和 npcs 数据
- **改进**：
  - 完整的数据流：App → NpcDetailModal → ChatInterface → Prompt Builder
  - 实时同步游戏状态到AI上下文
  - 支持多种子女匹配方式（parentId、父母名字、父母ID）

---

### 📖 新增文档

1. **[AI对话游戏状态集成.md](AI对话游戏状态集成.md)**
   - 完整的技术实现说明
   - 数据流程图
   - 使用示例和场景演示
   - 自定义扩展指南
   - 故障排除清单

2. **[AI对话测试指南.md](AI对话测试指南.md)**
   - 4个测试场景（子女、道侣、怀孕、婚配）
   - 调试技巧和数据检查
   - 常见问题排查表
   - 成功标志清单

---

### 🎯 使用示例

#### 场景 1: AI自动提及子女
```
玩家: 最近可好？
NPC AI: 夫君，天明在青云宗传来书信，说他在剑道上又有突破了。
        灵儿这几日也在认真修炼，我们的孩子都很争气呢。
```

#### 场景 2: 怀孕时的对话
```
玩家: 身体可还好？
NPC AI: 多谢夫君挂念，腹中的孩儿今日又踢了我好几下，看来是个调皮的。
```

#### 场景 3: 关心子女婚事
```
玩家: 天明的婚事办得如何？
NPC AI: 天明娶了李家的灵儿为妻，两人琴瑟和鸣，我们可以放心了。
```

---

### 🔧 技术细节

**修改的核心文件**：
1. `src/services/promptBuilder.js` - 游戏状态分析和上下文生成
2. `src/components/ChatInterface/index.jsx` - 接收并使用 gameState
3. `src/components/NpcDetailModal/index.jsx` - 构建 gameState 对象
4. `src/App.jsx` - 传递必要的游戏数据

**数据匹配逻辑**：
```javascript
// 多种方式匹配子女
const children = gameState.children?.filter(child => {
  if (child.parentId === npc.id) return true;           // 孙子辈
  if (child.fatherId === npc.id) return true;           // 通过父ID
  if (child.motherName === npc.name) return true;        // 通过母亲名字
  if (child.fatherName === npc.name) return true;        // 通过父亲名字
  return false;
});
```

---

### 🎨 未来计划

- [ ] 添加事件历史记录系统
- [ ] 支持情绪状态感知（开心、生气、忧伤等）
- [ ] 记忆摘要功能（长期对话）
- [ ] 多代家族关系（孙子辈互动）
- [ ] 宗门关系网络
- [ ] 季节和时间对对话的影响

---

**发布日期**: 2026年1月25日  
**版本**: v1.1.0  
**状态**: ✅ 已发布

---

## 版本 1.0.0 (2026-01-25)

### 🎉 重大更新：NPC 智能对话系统

为游戏新增了革命性的 AI 对话功能，让每个 NPC 都拥有真正的"灵魂"！

---

### ✨ 新增功能

#### 1. AI 服务通信层
- 📡 **文件**：`src/services/aiService.js`
- **功能**：
  - 支持所有兼容 OpenAI 格式的 API（DeepSeek、GPT、通义千问等）
  - 自动错误处理和重试机制
  - API 连接测试功能
  - 智能错误提示

#### 2. Prompt 构建系统
- 🎭 **文件**：`src/services/promptBuilder.js`
- **功能**：
  - 根据 NPC 性格动态生成人设
  - 智能识别好感度并调整态度
  - 强制使用古风/修仙用语
  - 控制回复长度（30-50字）
  - 严格角色扮演约束

#### 3. 聊天界面组件
- 💬 **文件**：`src/components/ChatInterface/index.jsx`
- **功能**：
  - 古色古香的聊天 UI 设计
  - 气泡式对话框（自己金色，NPC 白色）
  - 自动滚动到最新消息
  - 聊天记录本地存储（按 NPC ID 分别保存）
  - 一键清空聊天记录
  - 优雅的加载动画
  - 错误提示处理

#### 4. 系统配置面板升级
- ⚙️ **文件**：`src/components/Panels/SystemPanel.jsx`
- **新增配置项**：
  - API Key 输入（密码框）
  - API URL 输入（预填充常用地址）
  - 模型名称输入
  - 测试连接按钮
  - 配置保存功能
  - 快捷链接到各服务商官网

#### 5. NPC 详情页整合
- 📊 **文件**：`src/components/NpcDetailModal/index.jsx`
- **新增功能**：
  - 顶部标签页切换（详细属性 / 传音对话）
  - 未配置 API 时的友好提示界面
  - 详细配置指引
  - 无缝切换两种视图

#### 6. 样式增强
- 🎨 **文件**：`src/styles/main.css`
- **新增样式**：
  - 消息淡入动画 (`@keyframes fadeIn`)
  - 加载中的点点动画 (`loading-dots`)
  - 输入框聚焦效果
  - 链接悬停效果
  - 按钮禁用状态样式

#### 7. 完整文档
- 📚 **文件**：`docs/AI对话系统使用指南.md`
- **内容**：
  - 快速开始教程
  - API 配置指南（DeepSeek、OpenAI、通义千问）
  - 使用技巧和示例对话
  - 技术细节说明
  - 故障排除
  - 未来扩展建议

---

### 🎮 使用方法

#### 快速开始（3 步）

1. **获取 API Key**
   - 推荐 DeepSeek：https://platform.deepseek.com/
   - 注册后创建 API Key
   - 成本极低：¥10 可聊几千次

2. **配置游戏**
   ```
   进入游戏 → 点击【系统】→ 填写 AI 配置
   
   API Key: sk-your-key-here
   API URL: https://api.deepseek.com/chat/completions
   模型名称: deepseek-chat
   
   → 点击【测试连接】→ 点击【保存配置】
   ```

3. **开始对话**
   ```
   点击任意 NPC → 点击【💬 传音对话】标签 → 开始聊天！
   ```

---

### 🌟 核心特性

#### 智能角色扮演
每个 NPC 根据以下因素自动调整对话风格：
- **性格**：高冷、温柔、病娇、豪爽等
- **好感度**：
  - 0-30：冷淡敷衍
  - 30-60：正常礼貌
  - 60-80：友好热情
  - 80-100：亲昵深情
- **身份**：宗门长老、散修、魔修等
- **境界**：凡人、筑基、金丹、元婴等

#### 聊天记录系统
- ✅ 自动保存每个 NPC 的聊天历史
- ✅ 下次打开继续上次对话
- ✅ 支持一键清空
- ✅ 数据仅存本地，隐私安全

#### 古风沉浸体验
- 🏮 使用修仙界专属用语（道友、在下、本座等）
- 🎭 严格角色扮演，绝不跳戏
- 📜 古典 UI 设计，完美融入游戏风格
- ⚔️ 根据剧情自然回应

---

### 📊 技术亮点

#### 架构设计
```
用户输入
   ↓
ChatInterface (UI层)
   ↓
buildSystemPrompt (Prompt构建层)
   ↓
sendMessageToAI (通信层)
   ↓
LLM服务 (AI推理)
   ↓
返回回复 → 界面显示 → 本地存储
```

#### 数据存储
- **API配置**：`localStorage.game_api_key`、`game_api_url`、`game_api_model`
- **聊天记录**：`localStorage.npc_chat_history_{npcId}`

#### 性能优化
- 单次对话约 300 tokens
- DeepSeek 成本：约 ¥0.0003/次（0.03分）
- 响应时间：2-5 秒
- 支持并发多个 NPC 对话

---

### 💡 使用示例

#### 示例 1：与高冷师姐对话（好感度 30）
```
你: 师姐，今日修炼得如何了？
师姐: 与你何干。

你: 我突破筑基了！
师姐: 哦。
```

#### 示例 2：与温柔道侣对话（好感度 85）
```
你: 夫人，我闭关归来了。
道侣: 夫君终于回来了！妾身甚是想念，可有在外受伤？

你: 无碍，还为你带了件法宝。
道侣: 夫君有心了，妾身很是欢喜~
```

#### 示例 3：与病娇角色对话（好感度 90）
```
你: 我出门历练几日。
病娇: 不许去！你要是敢离开我，我就...

你: 好好好，我不去了。
病娇: 这还差不多，乖乖陪着我就好~
```

---

### 🚀 未来计划

#### 短期（1-2 周）
- [ ] 好感度回调（AI 回复影响游戏数据）
- [ ] 动态事件注入（刚送完礼立即对话）
- [ ] 聊天记录导出功能

#### 中期（1 个月）
- [ ] 语音输入/输出（Web Speech API）
- [ ] 群聊功能（同时与多个 NPC 对话）
- [ ] 自定义 Prompt 模板

#### 长期（未来）
- [ ] 本地 LLM 支持（无需联网）
- [ ] NPC 主动发起对话
- [ ] 对话影响剧情走向

---

### 🐛 已知问题

- 无

### 🔧 兼容性

- ✅ Chrome 90+
- ✅ Edge 90+
- ✅ Firefox 88+
- ✅ Safari 14+
- ✅ 移动端浏览器

---

### 🙏 致谢

- **DeepSeek** - 提供便宜好用的中文大模型
- **OpenAI** - 定义了标准的 Chat API 格式
- **React** - 强大的前端框架

---

### 📞 反馈和支持

如果遇到问题或有建议，请：
1. 查看 [使用指南](./AI对话系统使用指南.md)
2. 检查浏览器控制台（F12）的错误信息
3. 确认 API 配置是否正确

---

**享受你的智能修仙之旅吧！** ⚔️✨
