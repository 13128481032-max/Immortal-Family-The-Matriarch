# 背包整理与子嗣修为进度系统更新日志

## 更新日期
2026年1月26日

## 更新概述
本次更新新增了背包批量整理功能和子嗣修为进度条显示，提升了物品管理效率和信息可视化程度。

---

## 主要更新内容

### 1. 背包批量整理功能 📦

#### 功能说明
玩家可以在背包界面进入批量模式，一次性选择多个物品批量赠送给子女，大幅提升物品管理效率。

#### 核心功能
- **批量选择模式**：点击"批量整理"按钮进入批量模式
- **多选操作**：通过复选框选择多个物品
- **智能过滤**：自动识别可/不可赠送的物品
- **原因提示**：无法赠送的物品会显示原因说明
- **一键全选**："全选可赠"按钮快速选中所有可赠送物品
- **批量分配**：选定物品后一键分配给指定子女

#### 赠送规则
| 物品类型 | 是否可赠送 | 说明 |
|---------|-----------|------|
| 消耗品   | ✅ 可赠送 | 丹药类物品 |
| 武器     | ✅ 可赠送 | 可装备武器 |
| 防具     | ✅ 可赠送 | 可装备防具 |
| 饰品     | ✅ 可赠送 | 可装备饰品 |
| 功法秘籍 | ❌ 不可赠送 | 功法秘籍无法赠送 |

#### UI/UX特性
1. **批量模式指示器**
   - 进入批量模式后背景变为蓝色
   - 顶部工具栏显示已选数量
   - 退出批量模式自动清空选择

2. **视觉反馈**
   - 选中物品：蓝色边框 + 蓝色背景
   - 不可选物品：禁用复选框 + 红色警告提示
   - 物品卡片：可点击切换选择状态

3. **操作按钮**
   - 📦 批量整理：进入/退出批量模式
   - 批量分配：赠送选中的物品（灰色禁用/紫色可用）
   - 全选可赠：一键选中所有可赠送物品

#### 技术实现

**InventoryModal.jsx**
```javascript
// 选择状态管理
const [selectedItems, setSelectedItems] = useState([]);
const [isBatchMode, setIsBatchMode] = useState(false);

// 检查物品是否可以赠送
const canGiveItem = (item) => {
  if (item.type === 'manual') {
    return { allowed: false, reason: '功法秘籍无法赠送' };
  }
  // ... 其他类型检查
};

// 批量赠送处理
const handleBatchGive = () => {
  const giveableItems = selectedItems.filter(id => {
    const item = items.find(i => i.instanceId === id);
    return item && canGiveItem(item).allowed;
  });
  
  if (onBatchGive) {
    onBatchGive(giveableItems);
  }
};
```

**App.jsx**
```javascript
onBatchGive={(instanceIds) => {
  const itemsToGive = instanceIds
    .map(id => inventory.find(i => i.instanceId === id))
    .filter(Boolean);
  
  // 打开批量子女选择界面
  setChildSelectorModal({ 
    open: true, 
    items: itemsToGive, 
    isBatch: true 
  });
}}
```

---

### 2. 子女选择弹窗增强 👶

#### 批量模式支持
子女选择弹窗现在支持批量操作，可以一次性将多个物品赠送给同一个子女。

#### 显示优化
- **单个模式**：显示"将 [物品名] 分配给哪位子女？"
- **批量模式**：显示"批量分配 X 件物品给哪位子女？"
  - 列出前3个物品名称
  - 超过3个显示"...等X件"

#### 批量处理逻辑
```javascript
if (childSelectorModal.isBatch && childSelectorModal.items) {
  let successCount = 0;
  childSelectorModal.items.forEach(itm => {
    handleUseConsumable(child.id, itm.instanceId);
    successCount++;
  });
  
  showResult(
    '批量分配成功',
    `已将 ${successCount} 件物品分配给 ${child.name}`,
    true
  );
}
```

---

### 3. 子嗣修为进度条 ⚡

#### 功能说明
在子嗣详情页新增修为进度显示，完整展示子女的修炼状态和成长预期。

#### 显示内容
1. **当前境界**：显示子女当前修为境界
2. **进度条**：
   - 渐变紫色进度条（带闪光动画）
   - 百分比显示（当前/最大）
   - 经验数值显示
3. **修炼速度**：每月获得的经验值
4. **预计突破**：根据当前速度计算突破时间
   - 12个月内：显示月数
   - 超过12个月：显示年数
   - 颜色编码：绿色（快速）/ 橙色（较慢）

#### 视觉设计
```css
/* 进度条主体 */
background: linear-gradient(90deg, #9c27b0 0%, #d05ce3 100%)
height: 14px
borderRadius: 7px
boxShadow: 0 0 10px rgba(156, 39, 176, 0.5)

/* 闪光动画（复用shimmer） */
animation: shimmer 2s infinite

/* 信息卡片 */
background: rgba(156, 39, 176, 0.05)
border: 1px solid rgba(156, 39, 176, 0.1)
```

#### 代码位置
[ChildDetailModal/index.jsx](src/components/ChildDetailModal/index.jsx) - 第4.5节"修为进度"

#### 信息层级
```
修为进度
├── 当前境界（粗体显示）
├── 进度条
│   ├── 百分比
│   └── 视觉进度（带动画）
├── 经验数值（当前/最大）
└── 修炼速度
    ├── 经验/月
    └── 预计突破时间
```

---

## 文件修改清单

### 新增功能文件
- ✅ `src/components/Modals/InventoryModal.jsx` - 批量选择逻辑
- ✅ `src/components/Modals/ChildSelectorModal.jsx` - 批量模式支持
- ✅ `src/components/ChildDetailModal/index.jsx` - 子嗣修为进度条

### 核心逻辑文件
- ✅ `src/App.jsx` - 批量赠送处理 + 子女选择器增强

---

## 使用指南

### 批量整理物品

1. **进入批量模式**
   - 打开背包（📦 打开背包）
   - 点击"📦 批量整理"按钮

2. **选择物品**
   - 方式1：点击物品卡片切换选择状态
   - 方式2：点击复选框
   - 方式3：点击"全选可赠"快速全选

3. **查看不可赠送原因**
   - 不可赠送的物品会显示红色警告
   - 提示具体原因（如"功法秘籍无法赠送"）

4. **批量分配**
   - 点击"批量分配"按钮
   - 选择目标子女
   - 确认后自动分配所有物品

5. **退出批量模式**
   - 再次点击"✓ 批量模式"按钮
   - 自动清空选择状态

### 查看子嗣修为进度

1. 打开子嗣详情页
2. 滚动到"⚡ 修为进度"部分
3. 查看以下信息：
   - 当前境界
   - 修为进度百分比
   - 经验数值
   - 修炼速度（如果有）
   - 预计突破时间（如果有）

---

## 注意事项

### 批量整理
1. **功法秘籍无法批量赠送**
   - 功法秘籍属于特殊物品，不支持赠送
   - 尝试选择时会显示警告

2. **批量操作不可撤销**
   - 批量分配后立即生效
   - 物品从背包移除，无法恢复

3. **选择限制**
   - 只能选择可赠送的物品
   - 不可赠送的物品复选框禁用

### 修为进度
1. **显示条件**
   - 必须有 `tierTitle` 属性
   - 必须有 `currentExp` 和 `maxExp` 数据

2. **修炼速度计算**
   - 需要 `cultivationSpeed` 属性
   - 由游戏引擎自动计算和更新

3. **预计突破时间**
   - 基于当前修炼速度线性推算
   - 不考虑突破失败的可能性
   - 仅供参考

---

## 性能优化

### 批量操作
- 使用 `useState` 管理选择状态
- `filter` 过滤可赠送物品
- 批量处理减少重复操作

### 渲染优化
- 条件渲染：只在需要时显示批量工具栏
- 懒加载：进度条动画使用CSS而非JS
- 状态隔离：批量模式状态独立管理

---

## 后续优化建议

### 批量整理
1. **高级过滤**
   - 按物品类型过滤
   - 按稀有度过滤
   - 按装备槽位过滤

2. **批量操作扩展**
   - 批量出售
   - 批量分解
   - 批量使用

3. **智能推荐**
   - 根据子女属性推荐最佳物品
   - 显示装备后的战力变化
   - 自动匹配最合适的子女

### 修为进度
1. **历史记录**
   - 记录修为突破历史
   - 显示成长曲线图
   - 对比多个子女的成长速度

2. **突破提醒**
   - 即将突破时发送通知
   - 提醒准备突破资源
   - 计算突破成功率

3. **修炼加速**
   - 消耗资源加速修炼
   - 闭关修炼模式
   - 师徒传授功能

---

## 测试建议

### 批量整理测试
- [ ] 进入/退出批量模式
- [ ] 单选和多选物品
- [ ] 全选可赠送物品
- [ ] 尝试选择不可赠送物品
- [ ] 批量分配给不同子女
- [ ] 空选择状态下点击批量分配
- [ ] 批量模式下的视觉反馈

### 子嗣修为进度测试
- [ ] 显示正确的境界名称
- [ ] 进度条百分比计算正确
- [ ] 修炼速度显示正确
- [ ] 预计突破时间计算准确
- [ ] 进度条动画流畅
- [ ] 不同境界的显示效果
- [ ] 缺少数据时的降级显示

### 兼容性测试
- [ ] 现有存档正常加载
- [ ] 批量操作与单个操作结果一致
- [ ] 子嗣详情页其他功能不受影响
- [ ] 移动端触摸交互正常

---

## 版本信息
- **版本号**: v2.6.0
- **更新类型**: 功能新增 + UI优化
- **兼容性**: 向下兼容，现有存档无需迁移
- **测试状态**: 待测试

---

## 开发备注

本次更新重点提升了物品管理的效率和信息展示的直观性。批量整理功能解决了玩家频繁赠送物品的痛点，子嗣修为进度条则让玩家能够更清晰地了解子女的成长状态。

两个功能的UI设计保持了与现有系统的一致性，使用了相同的视觉风格和交互模式。闪光动画和渐变色的使用提升了整体的视觉体验。

未来可以考虑将批量操作扩展到其他系统（如NPC交互、探索等），形成更完整的批量管理体系。
