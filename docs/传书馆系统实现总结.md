# ä¼ ä¹¦é¦†ç³»ç»Ÿ - æŠ€æœ¯å®ç°æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

ä¼ ä¹¦é¦†ç³»ç»Ÿæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„æ¶ˆæ¯ä¸­å¿ƒï¼Œæ•´åˆäº†æ¸¸æˆä¸­æ‰€æœ‰æ–‡å­—å‰§æƒ…ç±»ä¿¡æ¯ï¼ˆå®¶ä¹¦ã€é—è¨€ã€ç¦»åˆ«å‘ŠçŸ¥ç­‰ï¼‰ã€‚æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº†ç³»ç»Ÿçš„æŠ€æœ¯å®ç°ç»†èŠ‚ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ ¸å¿ƒç»„ä»¶

```
src/
â”œâ”€â”€ game/
â”‚   â””â”€â”€ messageCenter.js          # æ¶ˆæ¯ç³»ç»Ÿæ ¸å¿ƒé€»è¾‘
â””â”€â”€ components/
    â””â”€â”€ MessageCenterModal/
        â”œâ”€â”€ MessageCenterModal.jsx # UIä¸»ç»„ä»¶
        â”œâ”€â”€ MessageCenterModal.css # æ ·å¼æ–‡ä»¶
        â””â”€â”€ index.js               # å¯¼å‡ºæ–‡ä»¶
```

### æ•°æ®æµ

```
æ¸¸æˆäº‹ä»¶ â†’ è§¦å‘é€»è¾‘ â†’ MessageManager â†’ çŠ¶æ€æ›´æ–° â†’ UIæ¸²æŸ“
   â†“                                        â†“
NPCæ­»äº¡/ç¦»åˆ«                              æ¶ˆæ¯åˆ—è¡¨
   â†“                                        â†“
æ¯æœˆæ£€æŸ¥                                  çº¢ç‚¹æé†’
```

## ğŸ’¾ æ•°æ®ç»“æ„

### æ¶ˆæ¯å¯¹è±¡ (Message)

```javascript
{
  id: "msg_timestamp_random",      // å”¯ä¸€æ ‡è¯†ç¬¦
  type: "LETTER" | "OBITUARY",     // æ¶ˆæ¯ç±»å‹
  senderId: "npc_001",             // å‘é€è€…ID
  senderName: "æ¥šæ¸…ç‘¶",             // å‘é€è€…å§“å
  title: "å¨˜äº²äº²å¯",                // æ¶ˆæ¯æ ‡é¢˜
  content: "...",                  // æ¶ˆæ¯å†…å®¹
  isRead: false,                   // æ˜¯å¦å·²è¯»
  status: "READY",                 // æ¶ˆæ¯çŠ¶æ€
  timestamp: {                     // å‘é€æ—¶é—´
    year: 5,
    month: 3
  },
  extras: {                        // é™„åŠ ä¿¡æ¯
    npcId: "npc_001",
    relation: "child",
    deathCause: "æ¸¡åŠ«å¤±è´¥"
  },
  createdAt: 1706342400000        // åˆ›å»ºæ—¶é—´æˆ³
}
```

### æ¶ˆæ¯ç±»å‹å¸¸é‡

```javascript
export const MESSAGE_TYPES = {
  LETTER: 'LETTER',           // æ—¥å¸¸å®¶ä¹¦
  OBITUARY: 'OBITUARY',       // é—è¨€/ç»ç¬”
  DEPARTURE: 'DEPARTURE',     // ç¦»åˆ«å‘ŠçŸ¥
  ACHIEVEMENT: 'ACHIEVEMENT', // æˆå°±é€šæŠ¥
};
```

### æ¶ˆæ¯çŠ¶æ€å¸¸é‡

```javascript
export const MESSAGE_STATUS = {
  PENDING: 'PENDING',     // ç”Ÿæˆä¸­
  READY: 'READY',         // å·²ç”Ÿæˆï¼Œæœªè¯»
  READ: 'READ',           // å·²è¯»
};
```

## ğŸ”§ æ ¸å¿ƒç±»ï¼šMessageManager

### ä¸»è¦æ–¹æ³•

```javascript
class MessageManager {
  constructor(maxMessages = 100, maxLetters = 50)
  
  // æ¶ˆæ¯ç®¡ç†
  addMessage(message)           // æ·»åŠ æ¶ˆæ¯
  markAsRead(messageId)         // æ ‡è®°å·²è¯»
  deleteMessage(messageId)      // åˆ é™¤æ¶ˆæ¯
  
  // æŸ¥è¯¢æ–¹æ³•
  getUnreadCount()              // è·å–æœªè¯»æ•°é‡
  getMessagesByType(type)       // æŒ‰ç±»å‹æŸ¥è¯¢
  getAllMessages()              // è·å–æ‰€æœ‰æ¶ˆæ¯
  
  // å­˜å‚¨ç®¡ç†
  cleanup()                     // æ¸…ç†æ—§æ¶ˆæ¯
  loadFromData(messagesData)    // ä»å­˜æ¡£æ¢å¤
  toJSON()                      // å¯¼å‡ºä¸ºJSON
}
```

### æ¸…ç†ç­–ç•¥

```javascript
cleanup() {
  // 1. åˆ†ç¦»é—è¨€å’Œæ™®é€šæ¶ˆæ¯
  const obituaries = messages.filter(m => m.type === 'OBITUARY');
  const regularMessages = messages.filter(m => m.type !== 'OBITUARY');
  
  // 2. åªæ¸…ç†æ™®é€šæ¶ˆæ¯ï¼ˆä¿ç•™æœ€è¿‘50å°ï¼‰
  if (regularMessages.length > maxLetters) {
    const toKeep = regularMessages.slice(0, maxLetters);
    messages = [...obituaries, ...toKeep];
  }
  
  // 3. æ€»æ•°é‡é™åˆ¶ï¼ˆæœ€å¤š100æ¡ï¼‰
  if (messages.length > maxMessages) {
    messages = messages.slice(0, maxMessages);
  }
}
```

## ğŸ“ æ¶ˆæ¯ç”Ÿæˆ

### é—è¨€ç”Ÿæˆ

**è§¦å‘æ—¶æœº**ï¼šNPCæ­»äº¡æ—¶ç«‹å³ç”Ÿæˆ

```javascript
// åœ¨ handleNextMonth ä¸­
const newlyDeadNpcs = npcsAfterLifecycle.filter(npc => npc.isDead);

if (newlyDeadNpcs.length > 0) {
  newlyDeadNpcs.forEach(deadNpc => {
    const obituaryMsg = createObituaryMessage(
      deadNpc, 
      player, 
      { year: nextYear, month: nextMonth }
    );
    messageManager.addMessage(obituaryMsg);
  });
  
  setMessages(messageManager.getAllMessages());
}
```

**å†…å®¹ç”Ÿæˆ**ï¼š

```javascript
export function createObituaryMessage(npc, player, gameTime) {
  const relation = determineRelation(npc, player);
  const content = generateObituaryContent(npc, player, gameTime, relation);
  
  return createMessage({
    type: MESSAGE_TYPES.OBITUARY,
    senderId: npc.id,
    senderName: npc.name,
    title: `${npc.name}çš„é—è¨€`,
    content,
    timestamp: { ...gameTime },
    extras: {
      npcId: npc.id,
      relation,
      deathCause: npc.deathCause || 'ä¸è¯¦',
    }
  });
}
```

### å®¶ä¹¦ç”Ÿæˆ

**è§¦å‘æ—¶æœº**ï¼šæ¯3ä¸ªæœˆæ£€æŸ¥ä¸€æ¬¡

```javascript
// åœ¨ handleNextMonth ä¸­
if (nextMonth % 3 === 0) {
  aliveNpcs.forEach(npc => {
    // åªæœ‰ä¸åœ¨ç©å®¶èº«è¾¹çš„NPCæ‰ä¼šå‘é€
    const isAway = npc.sect || npc.status === 'away';
    if (!isAway) return;
    
    // æ£€æŸ¥è·ç¦»ä¸Šæ¬¡å‘é€çš„æ—¶é—´
    const lastCheck = lastMessageCheck[npc.id] || 0;
    const monthsSinceLastMessage = currentMonthIndex - lastCheck;
    
    // åˆ¤æ–­æ˜¯å¦åº”è¯¥å‘é€
    if (shouldSendLetter(npc, monthsSinceLastMessage)) {
      const letterMsg = createLetterMessage(
        npc, 
        player, 
        { year: nextYear, month: nextMonth }, 
        true
      );
      messageManager.addMessage(letterMsg);
      
      // æ›´æ–°è®°å½•
      setLastMessageCheck(prev => ({
        ...prev,
        [npc.id]: currentMonthIndex
      }));
    }
  });
}
```

**æ¦‚ç‡è®¡ç®—**ï¼š

```javascript
export function shouldSendLetter(npc, monthsSinceLastMessage = 3) {
  if (monthsSinceLastMessage < 3) return false;
  
  let probability = 0.3; // åŸºç¡€30%
  
  // å¥½æ„Ÿåº¦åŠ æˆ
  const affection = npc.affection || 0;
  if (affection > 80) probability += 0.3;
  else if (affection > 60) probability += 0.2;
  else if (affection > 40) probability += 0.1;
  
  // æ€§æ ¼åŠ æˆ
  if (npc.traits?.includes('ç²˜äºº')) probability += 0.2;
  if (npc.traits?.includes('é«˜å†·')) probability -= 0.2;
  
  // é™åˆ¶åœ¨10%-90%ä¹‹é—´
  return Math.random() < Math.max(0.1, Math.min(0.9, probability));
}
```

### ç¦»åˆ«æ¶ˆæ¯

**è§¦å‘æ—¶æœº**ï¼šå­å¥³åŠ å…¥å®—é—¨æ—¶

```javascript
// åœ¨ handleAssignSect ä¸­
const departureMsg = createLetterMessage(
  { 
    id: child.id, 
    name: child.name, 
    gender: child.gender,
    sect: sectObj.name,
    cultivation: { stage: child.tierTitle },
    affection: 100,
  },
  player,
  player.time,
  true
);
messageManager.addMessage(departureMsg);
```

## ğŸ¨ UIç»„ä»¶

### ç»„ä»¶ç»“æ„

```jsx
<MessageCenterModal>
  <Header>
    <Title>ğŸ“œ ä¼ ä¹¦é¦†</Title>
    <CloseButton />
  </Header>
  
  <Filters>
    <FilterButton>å…¨éƒ¨</FilterButton>
    <FilterButton>å®¶ä¹¦</FilterButton>
    <FilterButton>ç»ç¬”</FilterButton>
  </Filters>
  
  <Content>
    <MessageList>
      <MessageItem />  {/* å·¦ä¾§åˆ—è¡¨ */}
    </MessageList>
    
    <MessageReader>  {/* å³ä¾§é˜…è¯»åŒº */}
      <ReaderHeader />
      <ReaderBody />
      <ReaderActions />
    </MessageReader>
  </Content>
</MessageCenterModal>
```

### æ ¸å¿ƒProps

```javascript
const MessageCenterModal = ({
  isOpen,              // æ˜¯å¦æ‰“å¼€
  onClose,             // å…³é—­å›è°ƒ
  messages,            // æ¶ˆæ¯åˆ—è¡¨
  onMarkAsRead,        // æ ‡è®°å·²è¯»å›è°ƒ
  onDeleteMessage,     // åˆ é™¤æ¶ˆæ¯å›è°ƒ
}) => {
  // ...
}
```

### çŠ¶æ€ç®¡ç†

```javascript
const [selectedMessageId, setSelectedMessageId] = useState(null);
const [activeFilter, setActiveFilter] = useState('all');

// è¿‡æ»¤æ¶ˆæ¯
const filteredMessages = useMemo(() => {
  if (activeFilter === 'all') return messages;
  if (activeFilter === 'letter') {
    return messages.filter(m => 
      m.type !== MESSAGE_TYPES.OBITUARY
    );
  }
  if (activeFilter === 'obituary') {
    return messages.filter(m => 
      m.type === MESSAGE_TYPES.OBITUARY
    );
  }
}, [messages, activeFilter]);
```

## ğŸ­ è§†è§‰æ•ˆæœ

### èƒŒæ™¯æ ·å¼

**å®¶ä¹¦èƒŒæ™¯**ï¼š
```css
.message-background-letter {
  background: 
    linear-gradient(90deg, rgba(139, 69, 19, 0.1) 1px, transparent 1px),
    linear-gradient(rgba(139, 69, 19, 0.1) 1px, transparent 1px),
    linear-gradient(135deg, #faf8f3 0%, #f0ebe0 100%);
  background-size: 20px 20px, 20px 20px, 100% 100%;
}
```

**é—è¨€èƒŒæ™¯**ï¼š
```css
.message-background-obituary {
  background: 
    radial-gradient(circle at 20% 80%, rgba(100, 100, 100, 0.05) 0%, transparent 50%),
    linear-gradient(135deg, #e8e8e8 0%, #d0d0d0 100%);
}

.message-background-obituary::before {
  content: 'ğŸ•¯ï¸';
  position: absolute;
  top: 20px;
  right: 20px;
  font-size: 32px;
  opacity: 0.3;
}
```

### çº¢ç‚¹åŠ¨ç”»

```css
@keyframes pulse {
  0%, 100% {
    opacity: 1;
    transform: scale(1);
  }
  50% {
    opacity: 0.5;
    transform: scale(1.2);
  }
}

.unread-dot {
  animation: pulse 2s infinite;
}
```

## ğŸ’¾ å­˜æ¡£é›†æˆ

### ä¿å­˜æ•°æ®

```javascript
const handleSave = () => {
  const gameState = {
    // ... å…¶ä»–æ•°æ®
    messages: messageManager.toJSON(),
    lastMessageCheck,
  };
  return saveGameToStorage(gameState);
};
```

### è¯»å–æ•°æ®

```javascript
const handleLoad = () => {
  const savedData = loadGameFromStorage();
  if (savedData) {
    // æ¢å¤æ¶ˆæ¯æ•°æ®
    if (savedData.messages) {
      messageManager.loadFromData(savedData.messages);
      setMessages(messageManager.getAllMessages());
    }
    if (savedData.lastMessageCheck) {
      setLastMessageCheck(savedData.lastMessageCheck);
    }
  }
};
```

## ğŸ”Œ é›†æˆç‚¹

### App.jsx ä¸­çš„çŠ¶æ€

```javascript
// æ¶ˆæ¯ä¸­å¿ƒç›¸å…³çŠ¶æ€
const [messageManager] = useState(() => new MessageManager());
const [messages, setMessages] = useState([]);
const [showMessageCenter, setShowMessageCenter] = useState(false);
const [lastMessageCheck, setLastMessageCheck] = useState({});
```

### è§¦å‘ç‚¹æ€»ç»“

1. **NPCæ­»äº¡** â†’ `handleNextMonth` â†’ ç”Ÿæˆé—è¨€
2. **æ¯3ä¸ªæœˆ** â†’ `handleNextMonth` â†’ æ£€æŸ¥å®¶ä¹¦
3. **å­å¥³å…¥å®—é—¨** â†’ `handleAssignSect` â†’ ç”Ÿæˆç¦»åˆ«æ¶ˆæ¯

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–

### æ¶ˆæ¯æ•°é‡é™åˆ¶

- æ™®é€šæ¶ˆæ¯ï¼šæœ€å¤š50æ¡
- é—è¨€ï¼šæ°¸ä¹…ä¿å­˜
- æ€»å®¹é‡ï¼šæœ€å¤š100æ¡

### Reactä¼˜åŒ–

```javascript
// ä½¿ç”¨ useMemo ç¼“å­˜è¿‡æ»¤ç»“æœ
const filteredMessages = useMemo(() => {
  // ...
}, [messages, activeFilter]);

// ä½¿ç”¨ useState(() => ...) åˆå§‹åŒ–
const [messageManager] = useState(() => new MessageManager());
```

## ğŸš€ æœªæ¥æ‰©å±•ç‚¹

### 1. AIå†…å®¹ç”Ÿæˆ

```javascript
async function generateAILetter(npc, player, gameTime) {
  const prompt = buildLetterPrompt(npc, player);
  const content = await callAIService(prompt);
  
  return createLetterMessage(npc, player, gameTime, content);
}
```

### 2. æ¶ˆæ¯é™„ä»¶

```javascript
{
  type: MESSAGE_TYPES.LETTER,
  // ...
  extras: {
    attachments: [
      { type: 'SPIRIT_STONE', amount: 100 },
      { type: 'ITEM', itemId: 'sword_001' }
    ]
  }
}
```

### 3. å›ä¿¡ç³»ç»Ÿ

```javascript
function sendReply(messageId, replyContent) {
  const message = messageManager.getMessageById(messageId);
  const sender = getNpcById(message.senderId);
  
  // å¢åŠ å¥½æ„Ÿåº¦
  updateAffection(sender, +5);
  
  // è®°å½•å›ä¿¡
  message.extras.hasReplied = true;
  message.extras.replyDate = currentGameTime;
}
```

## ğŸ› è°ƒè¯•æŠ€å·§

### æ§åˆ¶å°å‘½ä»¤

```javascript
// å¼ºåˆ¶ç”Ÿæˆæµ‹è¯•æ¶ˆæ¯
window.testMessage = () => {
  const testMsg = createLetterMessage(
    activeNpcs[0], 
    player, 
    player.time, 
    true
  );
  messageManager.addMessage(testMsg);
  setMessages(messageManager.getAllMessages());
};
```

### æ—¥å¿—è¾“å‡º

```javascript
// åœ¨å…³é”®ç‚¹æ·»åŠ æ—¥å¿—
console.log('[MessageCenter] ç”Ÿæˆé—è¨€:', obituaryMsg);
console.log('[MessageCenter] æœªè¯»æ•°é‡:', messageManager.getUnreadCount());
```

## ğŸ“– ç›¸å…³æ–‡æ¡£

- [ä¼ ä¹¦é¦†ç³»ç»Ÿä½¿ç”¨æŒ‡å—](./ä¼ ä¹¦é¦†ç³»ç»Ÿä½¿ç”¨æŒ‡å—.md)
- [NPCç”Ÿå‘½å‘¨æœŸç³»ç»Ÿæ–‡æ¡£](./NPCä¿®ä¸ºä¸ç”Ÿå‘½ç³»ç»Ÿæ›´æ–°æ—¥å¿—.md)
- [è®°å¿†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£](./è®°å¿†ç³»ç»ŸæŠ€æœ¯æ–‡æ¡£.md)

---

**ç‰ˆæœ¬**: v1.0.0  
**æ›´æ–°æ—¥æœŸ**: 2026-01-27  
**ä½œè€…**: GitHub Copilot
