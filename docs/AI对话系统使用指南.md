# AI 智能对话功能使用指南

## 🎯 功能概述

这是一个革命性的功能升级，通过接入大语言模型（LLM），让游戏中的每个 NPC 都拥有真正的"灵魂"，能够进行智能对话，不再是简单的复读机！

### 核心特性

✅ **真实对话** - 每个 NPC 根据其性格、好感度、身份进行角色扮演  
✅ **记忆系统** - 聊天记录自动保存，下次打开继续  
✅ **古风沉浸** - 使用修仙界用语，完美融入游戏世界观  
✅ **安全可控** - API Key 由玩家自己配置，数据安全  
✅ **成本友好** - 支持 DeepSeek 等便宜好用的国产模型  

---

## 📦 已实现的功能

### 1. AI 服务通信层 (`src/services/aiService.js`)

负责与兼容 OpenAI 格式的 API 进行通信。

**核心函数：**
- `sendMessageToAI()` - 发送消息到 AI 并获取回复
- `testAPIConnection()` - 测试 API 配置是否有效

**支持的服务商：**
- DeepSeek（推荐，便宜且擅长中文）
- OpenAI（GPT-4/3.5）
- 通义千问（阿里云）
- Kimi（月之暗面）
- 其他兼容 OpenAI 格式的服务

### 2. Prompt 构建层 (`src/services/promptBuilder.js`)

根据 NPC 属性动态生成角色扮演提示词。

**智能识别：**
- NPC 性格（高冷、温柔、病娇等）
- 好感度等级（决定对话态度）
- 修为境界和身份
- 玩家信息

**对话风格控制：**
- 古风/修仙用语
- 性格化语气
- 回复长度控制（30-50字）
- 严禁跳出角色

### 3. 聊天界面组件 (`src/components/ChatInterface/index.jsx`)

古色古香的聊天 UI，完美融入游戏风格。

**界面特色：**
- 📜 古典纸张背景纹理
- 💬 气泡式对话框（自己是金色，NPC 是白色）
- 🎭 NPC 头像显示（自动取名字首字）
- 🔄 自动滚动到最新消息
- 💾 聊天记录自动保存
- 🗑️ 一键清空记录

**交互功能：**
- 输入框支持 Enter 发送
- 发送中显示"对方正在凝神思索..."
- 错误提示友好处理

### 4. 系统配置面板 (`SystemPanel.jsx`)

在系统设置中新增 AI 配置模块。

**配置项：**
- API Key（密码框，安全输入）
- API URL（自动填充常用地址）
- 模型名称（根据服务商选择）

**辅助功能：**
- 🔌 测试连接按钮（验证配置有效性）
- 💾 保存配置（存储到 localStorage）
- 📝 快捷链接（DeepSeek、OpenAI 等官网）

### 5. NPC 详情页整合 (`NpcDetailModal/index.jsx`)

在 NPC 详情页添加"传音对话"功能。

**切换模式：**
- 📊 详细属性 - 查看 NPC 的各项数据
- 💬 传音对话 - 与 NPC 进行智能对话

**智能提示：**
- 未配置 API 时显示友好提示
- 提供详细的配置指引

---

## 🚀 快速开始

### 第一步：获取 API Key

#### 推荐方案 1：DeepSeek（便宜且好用）

1. 访问 [DeepSeek 开放平台](https://platform.deepseek.com/)
2. 注册并登录
3. 在 API Keys 页面创建新密钥
4. 记录 API Key（格式：`sk-xxxxxx`）

**成本参考：**
- 模型：deepseek-chat
- 价格：约 ¥1 元 = 100万 tokens
- 每次对话约 200-500 tokens
- 预计 ¥10 可以聊几千次

#### 方案 2：OpenAI（质量最高但较贵）

1. 访问 [OpenAI Platform](https://platform.openai.com/)
2. 需要国际信用卡和科学上网
3. 创建 API Key
4. 模型推荐：gpt-4o-mini（便宜）或 gpt-4（效果好）

#### 方案 3：通义千问（国内大厂）

1. 访问 [阿里云 DashScope](https://dashscope.aliyun.com/)
2. 阿里云账号登录
3. 开通灵积服务
4. 创建 API Key

### 第二步：配置游戏

1. **进入系统设置**
   - 启动游戏
   - 点击底部导航栏的【系统】按钮

2. **填写 AI 配置**
   
   **DeepSeek 配置示例：**
   ```
   API Key: sk-your-deepseek-key-here
   API URL: https://api.deepseek.com/chat/completions
   模型名称: deepseek-chat
   ```

   **OpenAI 配置示例：**
   ```
   API Key: sk-your-openai-key-here
   API URL: https://api.openai.com/v1/chat/completions
   模型名称: gpt-4o-mini
   ```

   **通义千问配置示例：**
   ```
   API Key: sk-your-qwen-key-here
   API URL: https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions
   模型名称: qwen-plus
   ```

3. **测试连接**
   - 点击【测试连接】按钮
   - 等待提示（成功或失败）
   - 成功后点击【保存配置】

### 第三步：开始对话

1. 打开任意 NPC 的详情页（点击 NPC 卡片）
2. 点击顶部的【💬 传音对话】标签
3. 在输入框中输入想说的话
4. 按 Enter 或点击【发送】按钮
5. 等待 NPC 的智能回复

---

## 💡 使用技巧

### 1. 对话示例

**场景：与高冷师姐对话（好感度 30）**

```
你: 师姐，今日修炼得如何了？
师姐: 与你何干。
```

**场景：与温柔道侣对话（好感度 85）**

```
你: 夫人，我闭关归来了。
道侣: 夫君终于回来了！妾身甚是想念，可有在外受伤？
```

### 2. 影响对话的因素

- **好感度**：低好感会冷淡，高好感会亲昵
- **性格**：不同性格说话方式完全不同
- **身份**：宗门长老、散修、魔修等语气各异
- **境界**：境界高的 NPC 可能更高傲

### 3. 进阶玩法

#### 记忆延续
聊天记录会自动保存，下次对话可以接续上次的话题：
```
第一次: 你: 师姐，我想学剑法。
        师姐: 你根骨太差，还是算了吧。

第二次: 你: 师姐，我已经突破筑基了！
        师姐: 哦？倒是有些进步，那便教你几招。
```

#### 角色扮演
可以尝试不同的对话风格：
- 正经修仙："晚辈欲请教前辈一事。"
- 日常闲聊："今天天气真好。"
- 送礼讨好："特意为道友准备了一份薄礼。"

### 4. 常见问题

**Q: AI 回复太慢？**  
A: 可能是网络问题或服务商负载高，稍等片刻。DeepSeek 通常 2-5 秒内回复。

**Q: AI 回复太长/太短？**  
A: 这是 Prompt 的温度和 max_tokens 参数控制的，已优化为 30-50 字。如需调整，可修改 `aiService.js` 中的参数。

**Q: AI 跳出角色说"我是 AI"？**  
A: Prompt 已严格禁止，如果仍出现可以：
  1. 换个说法重新问
  2. 清空聊天记录重新开始
  3. 提高模型版本（如从 gpt-3.5 换到 gpt-4）

**Q: 想删除某个 NPC 的聊天记录？**  
A: 打开该 NPC 的对话界面，点击右上角【清空】按钮。

**Q: API Key 泄露了怎么办？**  
A: 立即到服务商官网删除旧 Key，生成新 Key 重新配置。

---

## 🔧 技术细节

### 数据流程

```
用户输入 → ChatInterface → buildSystemPrompt → sendMessageToAI → LLM 服务 → 返回回复 → 界面显示
```

### 本地存储

- **API 配置**：`localStorage.game_api_key`, `game_api_url`, `game_api_model`
- **聊天记录**：`localStorage.npc_chat_history_{npcId}`

### Prompt 示例

```
【角色扮演指令】
你正在扮演一个修仙世界中的角色，请完全沉浸在这个身份中。

【你的身份】
姓名：玉灵仙子
身份：天机宗长老
修为境界：元婴期
年龄：218岁
性格特质：高冷（不苟言笑，话少冷淡）

【玩家信息】
玩家姓名：林风
玩家境界：筑基期
你对玩家的态度：陌生（好感度：15/100）

【对话风格要求】
1. 必须严格保持"高冷"的说话语气和行为方式
   - 话少、冷淡、惜字如金
2. 使用修仙界/古风用语：道友、在下、本座等
3. 回复长度：30-50字
...
```

---

## 🎨 界面预览

### 系统配置界面
```
┌─────────────────────────────┐
│ 🤖 AI 对话配置               │
├─────────────────────────────┤
│ API Key: [********]         │
│ API URL: [https://...]      │
│ 模型名称: [deepseek-chat]    │
│                             │
│ [💾 保存配置] [🔌 测试连接]  │
└─────────────────────────────┘
```

### 聊天界面
```
┌─────────────────────────────┐
│ 与 玉灵仙子 传音         [清空]│
├─────────────────────────────┤
│                             │
│  ┌──────────┐               │
│  │ 玉 │ 哼，小辈。           │
│  └──────────┘               │
│                             │
│               ┌──────────┐  │
│      道友可好? │ 林 │      │
│               └──────────┘  │
│                             │
├─────────────────────────────┤
│ [输入消息...        ] [发送] │
└─────────────────────────────┘
```

---

## 🚧 未来扩展建议

### 1. 好感度回调（进阶）

让 AI 的回复直接影响游戏数据：

```javascript
// 修改 aiService.js，使用 Function Calling
{
  "response": "多谢道友救命之恩！",
  "affection_change": +5,
  "trust_change": +3
}
```

解析后不仅显示对话，还真的增加游戏内好感度！

### 2. 动态事件注入

刚送完礼物立即对话时，在 Prompt 中注入：

```
【最新事件】
玩家刚刚送了你一份【定情信物】，你现在非常感动。
```

AI 的第一句回复就会提到这个礼物。

### 3. 多轮对话优化

目前的实现已经支持多轮对话记忆，但可以进一步：
- 提取关键话题标签
- 总结对话主题
- 在 System Prompt 中注入话题记忆

### 4. 语音对话（Web Speech API）

浏览器原生支持语音识别和合成：
```javascript
// 语音输入
const recognition = new webkitSpeechRecognition();
recognition.onresult = (event) => {
  const text = event.results[0][0].transcript;
  sendMessage(text);
};

// 语音播放
const utterance = new SpeechSynthesisUtterance(aiReply);
speechSynthesis.speak(utterance);
```

### 5. 多角色群聊

同时与多个 NPC 对话，AI 自动分配角色：
```
你: 大家好！
师姐: ...（高冷）
师妹: 师兄好呀~（活泼）
长老: 小辈有何事？（威严）
```

---

## 📊 性能和成本

### API 调用成本估算

**DeepSeek 示例：**
- 每次对话约 300 tokens（System Prompt 150 + 用户输入 50 + AI 回复 100）
- 价格：¥1 / 100万 tokens = ¥0.000001 / token
- 单次对话成本：300 × 0.000001 = ¥0.0003 元（0.03分）
- ¥10 可以对话约 33,333 次

### 优化建议

1. **限制 System Prompt 长度**：当前约 150 tokens，已较精简
2. **控制回复长度**：max_tokens 设为 150-200
3. **使用流式输出**：`stream: true`，边生成边显示
4. **添加缓存**：相同问题直接返回上次回复（需谨慎，会影响随机性）

---

## 🛡️ 安全和隐私

### 数据安全

- ✅ API Key 仅存储在用户本地浏览器（localStorage）
- ✅ 不经过任何第三方服务器
- ✅ 聊天记录仅保存在本地
- ✅ 清除浏览器缓存即可删除所有数据

### 最佳实践

1. **不要在公共设备上保存 API Key**
2. **定期检查 API Key 使用量**（在服务商后台）
3. **设置消费限额**（避免意外超支）
4. **不要分享你的 API Key**（会被盗刷）

---

## 📞 故障排除

### 常见错误码

| 错误码 | 原因 | 解决方案 |
|--------|------|----------|
| 401 | API Key 无效 | 检查 Key 是否正确，是否已过期 |
| 429 | 请求过于频繁 | 稍等片刻再试 |
| 500 | 服务商内部错误 | 等待服务恢复或换服务商 |
| Network Error | 网络连接失败 | 检查网络，确认 URL 正确 |

### 调试技巧

打开浏览器控制台（F12），查看：
- Network 标签：查看 API 请求详情
- Console 标签：查看错误日志
- Application → Local Storage：查看存储的配置

---

## 🎉 总结

这个 AI 对话功能是游戏沉浸感的**质变升级**！通过精心设计的 Prompt 和角色扮演机制，每个 NPC 都能展现出独特的性格和真实的情感。

**核心价值：**
- 🎭 **沉浸感爆棚** - 不再是冷冰冰的数值，而是活生生的角色
- 💰 **成本极低** - DeepSeek 每次对话不到 1 分钱
- 🔧 **易于扩展** - 可轻松添加更多玩法
- 🌏 **国产友好** - 无需科学上网，支持国内服务

**开始你的智能修仙之旅吧！** ⚔️✨
