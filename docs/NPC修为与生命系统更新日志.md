# NPC修为与生命系统更新日志

## 更新时间
2026年1月26日

## 更新概述
本次更新完善了NPC的修炼和生命系统，使NPC能够正常成长和死亡，同时优化了主角修炼速度的显示，并在开局剧情中加入了子嗣反哺系统的介绍。

---

## 核心功能

### 1. ✅ NPC修为正常增长系统

#### 修炼速度公式统一
NPC现在使用与主角相同的修炼速度计算公式：

```javascript
修炼速度 = 基础速度(10/月) × 资质系数 × 灵根系数 × 功法系数 × 宗门加成
```

#### 各项系数说明
- **基础速度**: 10点经验/月
- **资质系数**: `(资质/50)`，资质50为基准1.0倍
- **灵根系数**: 
  - 天灵根: 2.5倍
  - 变异灵根: 2.0倍
  - 单灵根: 1.8倍
  - 双灵根: 1.5倍
  - 三灵根: 1.0倍
  - 四灵根: 0.8倍
  - 五灵根: 0.5倍
- **功法系数**: 当前NPC使用基础功法(1.0倍)，未来可扩展
- **宗门加成**: 
  - 在宗且状态为active: 1.5倍
  - 散修/叛出/隐藏: 1.0倍

#### 与主角的区别
- ❌ NPC **没有**子嗣反哺加成
- ❌ NPC **没有**词条加成
- ✅ NPC使用基础功法，未来可根据身份分配特殊功法

### 2. ✅ 境界突破增加寿命

#### 寿命增长表
境界突破成功后，NPC会获得额外寿命：

| 境界阶段 | 每次突破增加寿命 |
|---------|----------------|
| 炼气期 | +20年 |
| 筑基期 | +50年 |
| 金丹期 | +200年 |
| 元婴期 | +500年 |

#### 示例
- NPC初始寿命: 100年
- 突破至炼气初期: 寿命变为 120年
- 突破至筑基初期: 寿命变为 170年
- 突破至金丹初期: 寿命变为 370年

### 3. ✅ NPC死亡系统

#### 死亡条件
- 当前年龄 ≥ 总寿命时，NPC会寿元耗尽而死

#### 死亡处理
1. **自动分离**: 每月推进时，死亡的NPC会自动从`activeNpcs`移至`deadNpcs`
2. **死亡日志**: 生成死亡事件日志: `💀 {NPC名字} 寿元耗尽，坐化而逝，享年 {年龄} 岁`
3. **不可互动**: 死亡的NPC无法再进行任何互动

#### 死亡NPC列表
- 在"情缘"标签页单独显示
- 标题: `💀 已故之人 (数量)`
- 显示信息:
  - NPC名字和身份
  - 最终境界
  - 享年
  - 死亡原因

#### UI展示
```
💀 已故之人 (2)
┌─────────────────────────────┐
│ 💀 陆昭 (剑修传人)            │
│    炼气圆满 · 享年 89 岁      │
│    寿元耗尽                   │
└─────────────────────────────┘
```

### 4. ✅ 主角修炼速度显示优化

#### 已包含子嗣反哺
PlayerPanel中正确显示：
```
⚡ 修炼速度: 45/月 (自身 30 + 子嗣反哺 15)
```

#### 公式拆解
```
自身修炼: 基础(10/月) × 资质 × 灵根 × 功法 × 词条 × 宗门
= 10 × 1.00 × 1.8 × 1.00 × 1.0 × 1.5 = 27

👶 子嗣反哺: +18/月
总修炼速度: 45/月
```

### 5. ✅ 开局剧情优化

#### 新增序章步骤
在原有3个序章场景后，新增2个场景：

**场景4: 天降奇遇**
> "就在你绝望之际，破庙中一道金光闪过。母亲留下的古玉碎裂，一道神秘声音在脑海响起..."

**场景5: 系统激活**
> 【子嗣反哺系统】已激活
> 
> 『诞育子嗣，血脉相连。每一位子女的修炼成长，都将反哺于你！』
> 
> 子嗣达到炼气期，每月为你提供修为反哺；境界越高，反哺越多。这是专属于你的逆天机缘！

#### 玩家体验
- 清晰了解核心玩法机制
- 明白为什么要培养子嗣
- 理解反哺系统的价值

---

## 技术实现

### 修改文件清单

#### 1. [npcLifecycle.js](c:\Users\24726\Desktop\DIY\shengzi\src\game\npcLifecycle.js)
- **修炼速度计算**: 使用统一的修炼公式
- **境界突破**: 添加寿命增长逻辑
- **宗门加成**: 检查NPC宗门状态并应用加成

#### 2. [App.jsx](c:\Users\24726\Desktop\DIY\shengzi\src\App.jsx)
- **死亡NPC状态**: 新增`deadNpcs`状态
- **死亡分离**: 每月推进时自动分离死亡NPC
- **UI显示**: 在NPC标签页显示死亡列表
- **存档系统**: 保存和加载死亡NPC列表

#### 3. [Prologue/index.jsx](c:\Users\24726\Desktop\DIY\shengzi\src\components\Prologue\index.jsx)
- **新增场景**: 添加2个序章场景介绍子嗣反哺系统

#### 4. [PlayerPanel/index.jsx](c:\Users\24726\Desktop\DIY\shengzi\src\components\PlayerPanel\index.jsx)
- **验证**: 确认修炼速度显示已正确包含子嗣反哺

---

## 游戏平衡

### NPC修炼速度示例

#### 资质50，双灵根NPC (普通)
- 基础: 10/月
- 资质: ×1.0
- 灵根: ×1.5
- 宗门: ×1.5 (在宗)
- **总计**: 22.5 ≈ 22/月

#### 资质85，单灵根NPC (优秀)
- 基础: 10/月
- 资质: ×1.7
- 灵根: ×1.8
- 宗门: ×1.5
- **总计**: 45.9 ≈ 45/月

#### 资质95，天灵根NPC (天才)
- 基础: 10/月
- 资质: ×1.9
- 灵根: ×2.5
- 宗门: ×1.5
- **总计**: 71.25 ≈ 71/月

### 寿命计算示例

#### 普通修士 (资质50，三灵根)
- 初始寿命: 100年
- 炼气圆满: 100 + 20×4 = 180年
- 筑基后期: 180 + 50×3 = 330年
- 预计最高: 筑基后期 (修炼太慢)

#### 优秀修士 (资质85，单灵根)
- 初始寿命: 100年
- 筑基后期: 100 + 80 + 150 = 330年
- 金丹中期: 330 + 400 = 730年
- 预计最高: 金丹期

#### 天才修士 (资质95，天灵根)
- 初始寿命: 100年
- 金丹中期: 100 + 80 + 150 + 400 = 730年
- 元婴老祖: 730 + 500 = 1230年
- 预计最高: 元婴期

---

## 与主角的对比

### 修炼速度对比 (假设都是资质85，单灵根)

| 角色类型 | 基础 | 资质 | 灵根 | 功法 | 词条 | 宗门 | 子嗣反哺 | 总计 |
|---------|-----|-----|-----|-----|-----|-----|---------|-----|
| 主角 | 10 | ×1.7 | ×1.8 | ×1.5 | ×1.5 | ×1.5 | +50 | 118/月 |
| NPC | 10 | ×1.7 | ×1.8 | ×1.0 | ×1.0 | ×1.5 | 0 | 45/月 |

**差距**: 主角修炼速度是NPC的2.6倍！

### 核心优势
1. **子嗣反哺**: 主角独有，可叠加多个子嗣
2. **功法加成**: 主角可获得高级功法
3. **词条加成**: 主角可获得特殊词条

---

## 已知限制

### 当前版本
- NPC功法系统暂未实现（都使用基础功法1.0倍）
- NPC词条系统暂未实现
- 死亡NPC只能查看，无法进行任何互动
- 死亡NPC不会产生世界事件

### 未来扩展
1. **NPC功法系统**: 根据身份和宗门分配特殊功法
2. **NPC词条系统**: 生成时随机获得词条
3. **死亡剧情**: 死亡NPC触发特殊剧情（遗物、传承等）
4. **转世系统**: 死亡NPC有概率转世重生
5. **墓碑系统**: 可以为死去的情缘立碑纪念

---

## 测试建议

### 测试场景1: NPC修为增长
1. 新建游戏，遇到几个NPC
2. 时间推进10-20月
3. 打开NPC详情，查看修为是否增长
4. 观察不同资质/灵根的NPC增长速度差异

### 测试场景2: 境界突破与寿命
1. 找一个资质较高的NPC (80+)
2. 长期培养，等待其突破
3. 突破后查看NPC详情中的寿命是否增加
4. 验证不同境界突破的寿命增长是否正确

### 测试场景3: NPC死亡
1. 找一个年龄较大的NPC（或修改代码加速时间）
2. 等待其寿元耗尽
3. 查看是否出现死亡日志
4. 在情缘标签页确认死亡列表是否显示

### 测试场景4: 修炼速度显示
1. 打开主角面板
2. 查看修炼速度是否显示子嗣反哺
3. 有子嗣时，验证公式拆解是否正确

### 测试场景5: 开局剧情
1. 新建游戏
2. 观看完整序章剧情
3. 确认子嗣反哺系统介绍是否清晰

---

## Bug修复

### 修复项
1. ✅ NPC修为不增长 → 现在使用正确的修炼公式
2. ✅ NPC寿命固定不变 → 突破时会增加寿命
3. ✅ NPC永不死亡 → 寿元耗尽会死亡
4. ✅ 主角修炼速度显示不包含反哺 → 已正确显示
5. ✅ 开局没有介绍核心玩法 → 新增序章场景

---

## 总结

本次更新让NPC真正"活"了起来：
- 🌱 他们会正常修炼成长
- ⚡ 他们会突破境界，获得更长寿命
- 💀 他们会寿元耗尽而死亡
- 📜 死亡后会被铭记在"已故之人"列表

同时，通过开局剧情的优化，玩家能更清楚地理解子嗣反哺这一核心玩法机制的重要性。

这让游戏世界更加动态和真实，时间的流逝不再只是数字，而是真实影响着每个NPC的命运！
