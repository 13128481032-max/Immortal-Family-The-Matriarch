# 传书馆系统 - 使用指南

## 📜 系统概述

传书馆是一个统一的消息中心系统，整合了游戏中所有文字剧情类信息，包括家书、遗言、离别告知等。采用非阻塞式后台生成机制，通过红点提醒驱动玩家主动查看，让玩家在空闲时沉浸式地阅读剧情，不会打断修仙节奏。

## ✨ 核心特性

### 1. 统一消息入口
- **集中管理**：所有文字剧情类消息都汇集到传书馆
- **分类清晰**：通过消息类型区分家书、遗言等不同内容
- **历史查阅**：所有消息都会保存，可随时翻阅

### 2. 消息类型

#### 家书 (LETTER)
- **来源**：不在身边的亲密NPC（子女、伴侣、好友）
- **触发时机**：每3个月检查一次，根据好感度和性格决定是否发送
- **内容**：报平安、诉思念、分享修炼心得等
- **概率因素**：
  - 好感度越高，发信概率越大
  - "粘人"、"重情重义"等性格会增加概率
  - "高冷"、"孤僻"等性格会降低概率

#### 遗言 (OBITUARY)
- **来源**：死亡的亲密NPC
- **触发时机**：NPC死亡时立即生成
- **内容**：临终嘱托、未了心愿、诀别之言
- **特殊保护**：遗言永不自动删除，可以永久保存

#### 离别消息 (DEPARTURE)
- **来源**：子女加入宗门时
- **触发时机**：子女12岁选择宗门后
- **内容**：告别父母，承诺努力修行

### 3. 后台生成机制
- **不阻塞流程**：消息在后台生成，不影响游戏正常推进
- **异步加载**：支持AI生成（如果配置了API）或使用模板
- **静默处理**：玩家无需等待，生成完成后自动显示红点

### 4. 红点提醒系统
- **实时更新**：有新的未读消息时，传书馆按钮显示红点
- **数量显示**：红点上显示未读消息数量
- **自动消失**：消息标记为已读后，红点相应减少

## 🎮 使用方法

### 查看消息
1. 点击主界面左下角的 📜 按钮打开传书馆
2. 左侧显示消息列表，右侧显示阅读区域
3. 点击任一消息即可阅读详细内容

### 消息筛选
- **全部**：查看所有类型的消息
- **家书**：只显示日常家书和离别消息
- **绝笔**：只显示遗言和绝笔

### 消息操作
- **阅读**：点击消息查看详情，自动标记为已读
- **回信**：（未来功能）回复家书
- **删除**：删除不需要的消息
- **缅怀**：对遗言表示缅怀（纪念功能）

## 🎨 视觉设计

### 家书样式
- **背景**：泛黄的宣纸纹理，温馨暖色调
- **字体**：楷体风格，古朴典雅
- **图标**：✉️ 信封图标

### 遗言样式
- **背景**：素白或深灰色水墨背景，带有落叶特效
- **字体**：楷体风格，沉重肃穆
- **图标**：🕯️ 蜡烛图标
- **氛围**：悲凉冷色调，突出离别之痛

## 📊 消息生成规则

### 家书生成概率

基础概率为30%，受以下因素影响：

**好感度影响：**
- 好感度 > 80：+30%
- 好感度 > 60：+20%
- 好感度 > 40：+10%

**性格影响：**
- 粘人/重情重义：+20%
- 高冷/孤僻：-20%

**最终概率范围：** 10% - 90%

### 检查周期
- 每3个月检查一次所有不在身边的NPC
- 只有满足条件的NPC才会发送消息

### 消息保存
- **普通家书**：最多保存50封，超出后自动清理旧消息
- **遗言**：永久保存，不计入普通消息上限
- **总容量**：最多保存100条消息

## 💾 存档支持

传书馆系统完全集成到游戏存档中：
- 所有消息内容会保存到存档
- 已读/未读状态会保存
- 消息发送记录会保存
- 读档后完整恢复所有数据

## 🔮 未来扩展

### 计划中的功能
1. **回信系统**：可以回复家书，影响NPC好感度
2. **赠礼附件**：家书可能包含灵石、法宝等礼物
3. **触发任务**：特殊消息可能触发支线任务
4. **AI深度整合**：使用AI生成更个性化的内容
5. **语音朗读**：为重要消息添加语音朗读功能

### 可能的消息类型
- **喜讯**：子女突破、获得成就
- **求援**：NPC遇到危险，请求帮助
- **邀约**：邀请参加宗门大比、婚礼等
- **报仇**：仇人发来挑战书

## 📝 开发说明

### 核心文件
- `src/game/messageCenter.js` - 消息系统核心逻辑
- `src/components/MessageCenterModal/` - UI组件
- `src/App.jsx` - 系统集成和状态管理

### 扩展开发
如需添加新的消息类型：

1. 在 `messageCenter.js` 中添加新的 `MESSAGE_TYPES` 常量
2. 创建对应的内容生成模板
3. 在合适的事件触发点调用 `createMessage` 函数
4. 在UI组件中添加相应的样式和显示逻辑

### 模板系统
所有消息内容都使用模板系统生成，支持：
- 随机文本选择
- 变量插值（NPC名称、时间、境界等）
- 条件分支（根据关系、好感度等）

## 🎯 设计理念

传书馆系统的设计遵循以下原则：

1. **不打断节奏**：后台生成，红点提醒，让玩家自主选择查看时机
2. **沉浸式体验**：精心设计的视觉效果和文案，营造修仙世界的氛围
3. **情感连接**：通过文字建立玩家与NPC之间的情感纽带
4. **记忆载体**：保存重要的剧情时刻，让故事更有厚度

---

**版本**: v1.0.0  
**更新日期**: 2026-01-27  
**作者**: GitHub Copilot
