# NPC 记忆系统 - 使用指南

## 概述

让 LLM "记得" NPC 在游戏中经历的一切重要事情，通过**分层记忆存储**和**智能上下文注入**实现真正的角色沉浸感。

---

## 核心原理

### LLM 的"记忆"本质

> LLM 本身没有记忆，每次对话都是全新的。  
> 我们通过**在每次请求时注入关键信息**，让它"以为"自己记得过去。

### 实现策略：记忆宫殿（三层存储）

```
NPC.memories
├── milestones       → 里程碑（永久记忆）：生子、结缘、生死关头
├── recentEvents     → 近期事件（短期记忆）：最近20条交互
└── longTermSummary  → 长期摘要（压缩记忆）：自动生成的往事概述
```

---

## 快速开始

### 1. 在游戏事件中记录记忆

#### 示例：NPC 生子时

```javascript
import MemoryManager from './game/memoryManager.js';

// 在生子逻辑中调用
const handleChildBirth = (npc, child) => {
  // 其他游戏逻辑...
  
  // 记录记忆（自动记录里程碑 + 近期事件）
  MemoryManager.onChildBirth(npc, child, {
    difficulty: "难产",  // "难产" | "顺利"
    sacrifice: true      // 是否损耗修为
  });
};
```

#### 示例：结为道侣时

```javascript
const handleMarriage = (npc) => {
  MemoryManager.onMarriage(npc, "天都峰");
};
```

#### 示例：送礼物时

```javascript
const handleGift = (npc, item, affectionChange) => {
  MemoryManager.onReceiveGift(npc, item, affectionChange);
  
  // 如果礼物特别贵重（好感度 +20），会自动升级为里程碑
};
```

---

### 2. AI 对话时自动加载记忆

记忆系统已集成到 `promptBuilder.js` 中，**无需额外代码**，对话时会自动：

1. ✅ 检测用户消息中的关键词（如"孩子"、"痛苦"、"后悔"）
2. ✅ 提取匹配的里程碑记忆
3. ✅ 注入到 System Prompt 中
4. ✅ 添加情感引导指令（如"回忆起生产之痛"）

#### 对话效果示例

**场景：玩家问 NPC "你后悔吗？"**

```
【之前（无记忆系统）】
AI: "我不后悔，修行路本就艰辛。"（太抽象，缺乏细节）

【现在（有记忆系统）】
System Prompt 中注入了：
"【刻骨铭心的记忆】
1. 为你生子（天元5年春）
   难产，甚至为此损耗了修为根基，孩子取名张小凡。
   情感烙印：刻骨铭心"

AI: "看着小凡一天天长大，当年的痛，便都不算什么了。"
```

---

## 高级用法

### 手动添加自定义里程碑

```javascript
import { addMilestone, EmotionalImpact } from './game/memorySystem.js';

addMilestone(npc, {
  event: "与你共闯禁地",
  time: "天元3年秋",
  detail: "在上古遗迹中，我们九死一生，最终得到了传承。",
  emotionalImpact: EmotionalImpact.UNFORGETTABLE,
  category: "combat",
  tags: ["冒险", "禁地", "生死与共"]
});
```

### 记录普通事件

```javascript
import { recordRecentEvent } from './game/memorySystem.js';

recordRecentEvent(npc, {
  description: "与你一起在湖边赏月",
  affectionChange: 8,
  context: "浪漫的夜晚"
});
```

### 将事件升级为里程碑

```javascript
import { promoteToMilestone } from './game/memorySystem.js';

// 某个事件特别重要，手动升级
const event = npc.memories.recentEvents[0];
promoteToMilestone(npc, event, "这次对话改变了我们的关系");
```

---

## 记忆层级说明

### 里程碑（Milestones）- 永久记忆

**特点**：
- 永久保存，不会被删除
- 优先级最高，每次对话都会注入
- 适用场景：生子、结缘、生死时刻、重大突破

**情感烙印等级**：
- `刻骨铭心`：生子、救命、结缘
- `深刻`：重伤、突破境界
- `重要`：结拜、拜师
- `值得记住`：珍贵礼物、并肩作战

### 近期事件（Recent Events）- 短期记忆

**特点**：
- 最多保留 20 条
- 先进先出（FIFO），旧的会被挤掉
- 重要的会被升级为里程碑

**适用场景**：
- 日常对话
- 普通送礼
- 一起探险
- 情绪波动

### 长期摘要（Long-term Summary）- 压缩记忆

**特点**：
- 每积累 50 个事件自动触发摘要
- 调用 AI 压缩，生成 100-150 字的概述
- 节省 Token，同时保留关键信息

**工作流程**：
```
50个事件 → AI摘要 → 压缩为一段话 → 清空这50条 → 保留摘要
```

---

## 集成到游戏引擎

### 在游戏初始化时

```javascript
import MemoryManager from './game/memoryManager.js';

// 初始化所有 NPC 的记忆系统
MemoryManager.initializeAllNpcs(gameState.npcs);

// 为已有子女的 NPC 补录记忆
gameState.npcs.forEach(npc => {
  const children = gameState.children.filter(c => 
    c.fatherName === npc.name || c.motherName === npc.name
  );
  if (children.length > 0) {
    MemoryManager.backfillChildrenMemories(npc, children);
  }
});
```

### 在生子逻辑中

找到生子的代码（可能在 `gameEngine.js` 或 `npcLifecycle.js`），添加：

```javascript
// 在 handleChildBirth 函数中
const handleChildBirth = (parent, child) => {
  // ...原有逻辑...
  
  // 🆕 记录记忆
  MemoryManager.onChildBirth(parent, child, {
    difficulty: Math.random() > 0.7 ? "难产" : "顺利",
    sacrifice: Math.random() > 0.85 // 15% 概率损耗修为
  });
};
```

### 在送礼逻辑中

```javascript
import MemoryManager from './game/memoryManager.js';

const handleGift = (npc, item) => {
  // 计算好感度变化
  const affectionChange = calculateAffectionChange(item);
  
  // 应用好感度
  npc.relationship.affection += affectionChange;
  
  // 🆕 记录记忆
  MemoryManager.onReceiveGift(npc, item, affectionChange);
};
```

---

## 关键词触发系统

当玩家提到以下关键词时，系统会自动唤起相关记忆：

| 类别       | 关键词                                                      |
| ---------- | ----------------------------------------------------------- |
| 家庭       | 孩子、子女、儿子、女儿、父亲、母亲、爹娘、孕、怀孕、生子   |
| 关系       | 道侣、结缘、婚配、夫妻、爱、情、思念、想念                  |
| 修炼       | 突破、境界、修炼、功法、灵力、渡劫、飞升                   |
| 战斗       | 战斗、厮杀、受伤、重伤、生死、救命、护你                   |
| 情感       | 疼、痛、苦、难、后悔、幸福、快乐、悲伤                     |

**示例：**

玩家："那次难产你受了很多苦吧？"

→ 系统检测到关键词：`难产`、`苦`  
→ 自动唤起"生子"里程碑  
→ 注入特殊指令："请回忆起生产之痛"  
→ AI 回复："那种撕心裂肺的痛，我这辈子都忘不了...但看着小凡，一切都值得。"

---

## 数据结构详解

### NPC 完整数据结构

```javascript
{
  id: 1,
  name: "陆昭",
  // ...其他属性...
  
  // 🆕 记忆系统
  memories: {
    // A. 基础档案（静态）
    profile: {
      name: "陆昭",
      personality: "坚韧",
      identity: "落魄散修",
      firstMeet: "2026-01-26T12:00:00Z"
    },
    
    // B. 里程碑（核心记忆）
    milestones: [
      {
        id: 1738056789123,
        event: "为你生子",
        time: "天元5年春",
        detail: "难产，甚至为此损耗了修为根基，孩子取名张小凡。当年的痛，便都不算什么了。",
        emotionalImpact: "刻骨铭心",
        category: "family",
        tags: ["生子", "孩子", "张小凡", "牺牲"],
        createdAt: "2026-01-26T12:00:00Z"
      }
    ],
    
    // C. 近期事件（最多20条）
    recentEvents: [
      {
        id: 1738056789456,
        description: "收到你赠送的飞剑",
        time: "2026-01-26T12:00:00Z",
        affectionChange: 10,
        context: "玩家正在讨好我"
      }
    ],
    
    // D. 长期摘要
    longTermSummary: "在天元元年相识，历经风雨...（AI自动生成）",
    
    // E. 元数据
    meta: {
      totalEvents: 125,
      lastSummaryTime: "2026-01-20T12:00:00Z",
      needsSummary: false
    }
  }
}
```

---

## 在 UI 中展示记忆（可选）

### 创建"回忆录"界面

在 NPC 详情页添加"回忆录"标签页：

```jsx
import MemoryManager from '../game/memoryManager.js';

const NpcDetailModal = ({ npc }) => {
  const memorySummary = MemoryManager.getMemorySummary(npc);
  
  return (
    <div>
      <h3>刻骨铭心的记忆 ({memorySummary.milestoneCount})</h3>
      {memorySummary.milestones.map(m => (
        <div key={m.id} style={styles.milestone}>
          <strong>{m.event}</strong> ({m.time})
          <p>{m.detail}</p>
          <span className="emotional-tag">{m.emotionalImpact}</span>
        </div>
      ))}
      
      <h3>最近经历 ({memorySummary.recentEventCount})</h3>
      {memorySummary.recentEvents.map(e => (
        <div key={e.id}>{e.description}</div>
      ))}
    </div>
  );
};
```

---

## 最佳实践

### ✅ 应该记录的事件

1. **生命节点**：出生、死亡、转世
2. **关系变化**：初次相遇、结缘、决裂、重归于好
3. **重大牺牲**：为玩家受伤、损耗修为、背叛宗门
4. **子女相关**：怀孕、生产、子女拜师、子女成婚
5. **共同经历**：并肩作战、一起渡劫、探索禁地

### ❌ 不应该记录的事件

1. 琐碎对话（"你好"、"天气真好"）
2. 重复性事件（每天修炼、吃饭）
3. 无意义的动作（走路、打坐）

### 🎯 记忆分级策略

- **里程碑**：生子、结缘、生死关头（≤10个）
- **近期事件**：送礼、战斗、探险（≤20个）
- **长期摘要**：自动压缩（1段话）

---

## 关键词触发机制

### 工作原理

1. 玩家发送消息："那次难产你受苦了"
2. 系统检测关键词：`难产`、`苦`
3. 从里程碑中匹配含有这些关键词的记忆
4. 注入到 System Prompt：
   ```
   【相关回忆被唤起】
   想起了天元5年春为你生子的往事...难产，甚至为此损耗了修为根基
   
   ⚠️ 玩家提到了痛苦相关的话题，请在回复中回忆起那段经历。
   ```
5. AI 据此生成带有情感深度的回复

---

## 进阶功能

### 自动摘要（节省 Token）

当 NPC 积累了 50 个事件后：

```javascript
import { generateMemorySummary } from './game/memorySystem.js';

// 需要你提供一个 AI 摘要函数
const aiSummarizer = async (text, options) => {
  const prompt = `请将以下事件压缩为一段 ${options.maxLength} 字的叙事摘要：\n${text}`;
  // 调用 AI API...
  return summary;
};

// 生成摘要
await generateMemorySummary(npc, aiSummarizer);
```

### 补录历史记忆（兼容旧存档）

如果你的游戏已经有很多玩家和子女数据了：

```javascript
// 在游戏加载时执行一次
MemoryManager.backfillChildrenMemories(npc, existingChildren);
```

---

## 实际集成示例

### 完整流程：生子 → 对话

```javascript
// 1. 玩家触发生子事件
const child = createChild(player, npc);
MemoryManager.onChildBirth(npc, child, { 
  difficulty: "难产", 
  sacrifice: true 
});

// 2. NPC 数据现在包含：
npc.memories.milestones[0] = {
  event: "为你生子",
  detail: "难产，损耗修为，孩子取名XXX",
  emotionalImpact: "刻骨铭心",
  tags: ["生子", "孩子", "XXX"]
};

// 3. 玩家几个月后点击"对话"
// ChatInterface 组件自动调用 buildSystemPrompt(npc, player, gameState, "")
// → extractMemories 提取里程碑
// → 注入到 System Prompt

// 4. 玩家输入："你后悔吗？"
// → detectContextKeywords 检测到"后悔"
// → 添加指令："请结合过往经历真诚回应"
// → AI 回复："看着我们的孩子，当年的苦都值得。"
```

---

## 调试与查看

### 查看 NPC 当前记忆

```javascript
console.log(npc.memories);

// 或使用管理器
const summary = MemoryManager.getMemorySummary(npc);
console.log(`里程碑: ${summary.milestoneCount}个`);
console.log(`近期事件: ${summary.recentEventCount}个`);
console.log(`总事件: ${summary.totalEvents}个`);
```

### 清空记忆（测试用）

```javascript
MemoryManager.clearAllMemories(npc);
```

---

## 性能优化

### Token 控制策略

| 数据类型   | 数量限制 | 平均 Token | 总 Token |
| ---------- | -------- | ---------- | -------- |
| 里程碑     | ≤10个    | ~80        | ~800     |
| 近期事件   | ≤20个    | ~30        | ~600     |
| 长期摘要   | 1段话    | ~150       | ~150     |
| **合计**   |          |            | ~1550    |

加上人设和规则约 800 Token，总计约 **2350 Token**，在大部分 LLM 的限制内（通常 4k-8k）。

---

## 常见问题

### Q: 如果游戏时间跨度很长（100年），记忆会不会爆炸？

A: 不会。里程碑只保留真正重要的事件（人为筛选），近期事件最多 20 条，其余会被压缩成摘要。

### Q: AI 会不会忘记里程碑？

A: 不会。里程碑是永久记忆，每次对话都会注入到 System Prompt 中。

### Q: 如何让 AI 提到某个特定记忆？

A: 在对话中使用关键词。例如想让他提到孩子，就问"我们的孩子最近怎么样？"

### Q: 记忆系统会影响性能吗？

A: 几乎不会。只是在构建 Prompt 时多拼接几段文字，开销可以忽略。

---

## 示例对话效果

### 场景一：询问生子经历

**玩家**: "那次你为我生孩子，很痛吧？"  
**AI（无记忆）**: "是有些痛苦，但已经过去了。"  
**AI（有记忆）**: "何止是痛...那种撕心裂肺的感觉，我这辈子都忘不了。但看着小凡一天天长大，我从未后悔过。"

### 场景二：询问孩子近况

**玩家**: "小凡最近怎么样？"  
**AI（无记忆）**: "他...还好吧。"  
**AI（有记忆）**: "小凡已经十岁了，前些日子刚拜入青云门，天赋不俗，我甚是欣慰。"

### 场景三：询问感受

**玩家**: "你觉得值得吗？"  
**AI（无记忆）**: "修行路本就艰辛，一切皆是命数。"  
**AI（有记忆）**: "当年为你损耗修为之时，我未曾犹豫。如今看你我子女成才，这点代价又算得了什么？"

---

## 未来扩展

### 可选功能（暂未实现）

1. **记忆淡化**：时间越久的记忆，情感强度逐渐降低
2. **记忆冲突**：如果玩家伤害过 NPC，又送礼讨好，AI 会纠结
3. **记忆共享**：子女能"听说"父母的过往
4. **记忆可视化**：在 UI 上用时间轴展示 NPC 一生

---

## 总结

这套系统让 LLM 真正"记得"：

✅ 他为你生过孩子  
✅ 你们经历的生死时刻  
✅ 他送过你什么礼物  
✅ 你们的孩子现在在哪个宗门  

当玩家问"你后悔吗？"时，AI 不再只是说"不后悔"，而是会回忆起具体的细节，带着真实的情感回应。

**这就是记忆宫殿的力量。**
