# 记忆系统更新日志

## v1.0.1 - 2026-01-26

### 🔄 功能调整

- **移除前端回忆录展示**：为避免与现有"NPC 日志系统"功能重复，移除了 NpcDetailModal 中的"📖 回忆录"标签页
- **保留后端记忆功能**：记忆系统继续在后台为 AI 对话提供智能上下文注入
- **明确功能定位**：记忆系统专注于服务 AI 对话，不需要单独的前端可视化界面
- **查看建议**：如需查看 NPC 生活记录，请使用游戏已有的"📖 查看XX的日志"功能（第一人称日记形式，需好感度 30+）

### 💡 设计理念

记忆系统和日志系统的区别：
- **记忆系统**：为 AI 对话提供上下文数据，结构化存储，关键词触发
- **日志系统**：面向玩家展示，第一人称日记形式，好感度门槛

两个系统各司其职，互不冲突。

---

## v1.0.0 - 2026-01-26

### 🎯 核心功能

实现了让 LLM "记得" NPC 在游戏中经历的一切重要事情的**记忆宫殿系统**。

### ✨ 新增特性

#### 1. 分层记忆存储

- **里程碑（Milestones）**：永久保存重大人生节点
  - 生子、结缘、生死关头、重大突破
  - 带有情感烙印等级（刻骨铭心、深刻、重要、值得记住）
  - 每次对话都会注入到 System Prompt

- **近期事件流（Recent Events）**：短期记忆
  - 最多保留 20 条
  - 记录日常交互（送礼、对话、探险）
  - 重要事件可升级为里程碑

- **长期摘要（Long-term Summary）**：压缩记忆
  - 每 50 个事件自动触发 AI 摘要
  - 压缩为 100-150 字的概述
  - 节省 Token，保留关键信息

#### 2. 智能记忆提取

- 根据好感度、关系阶段动态提取记忆
- 按情感烙印等级排序（最重要的优先展示）
- 支持最多提取 10 个里程碑 + 5 条近期事件

#### 3. 关键词触发机制

系统自动检测以下关键词并唤起相关记忆：

| 类别 | 关键词 |
|------|--------|
| 家庭 | 孩子、子女、儿子、女儿、父亲、母亲、爹娘、孕、怀孕、生子、诞下 |
| 关系 | 道侣、结缘、婚配、夫妻、爱、情、思念、想念 |
| 修炼 | 突破、境界、修炼、功法、灵力、渡劫、飞升 |
| 战斗 | 战斗、厮杀、受伤、重伤、生死、救命、护你 |
| 情感 | 疼、痛、苦、难、后悔、幸福、快乐、悲伤 |

**效果演示：**

```
玩家: "那次难产你受苦了吧？"
→ 检测关键词: ['难产', '苦']
→ 唤起记忆: "为你生子（难产、损耗修为）"
→ 添加指令: "请回忆起生产之痛"
→ AI: "那种撕心裂肺的痛，我这辈子都忘不了...但看着小凡，一切都值得。"
```

#### 4. 自动记忆管理器

提供便捷的 API，在游戏关键事件中自动记录：

- `MemoryManager.onChildBirth(npc, child, options)` - 生子
- `MemoryManager.onMarriage(npc, place)` - 结缘
- `MemoryManager.onReceiveGift(npc, item, affectionChange)` - 送礼
- `MemoryManager.onChildJoinSect(npc, child, sectName)` - 子女拜师
- `MemoryManager.onChildMarriage(npc, child, spouseName)` - 子女成婚
- `MemoryManager.onBreakthrough(npc, newTier)` - 突破境界
- `MemoryManager.onCombatTogether(npc, enemyName, wasRescued)` - 并肩作战

#### 5. 历史记忆补录

对于已有存档，系统会自动：
- 初始化所有 NPC 的记忆结构
- 为已有子女的 NPC 补录"生子"里程碑
- 兼容旧的 `eventHistory` 数据

### 🔧 技术实现

#### 新增文件

1. **`src/game/memorySystem.js`**
   - 记忆数据结构定义
   - 记忆提取与压缩算法
   - 关键词检测引擎
   - 快捷记忆模板

2. **`src/game/memoryManager.js`**
   - 游戏事件自动录入器
   - 统一的记忆管理 API
   - 批量初始化工具

3. **`src/game/memoryExamples.js`**
   - 使用示例代码
   - 测试函数

4. **`docs/记忆系统使用指南.md`**
   - 完整的开发文档
   - 集成指南
   - 最佳实践

#### 修改文件

1. **`src/services/promptBuilder.js`**
   - 集成记忆提取功能
   - 支持关键词检测
   - 动态构建包含记忆的 System Prompt

2. **`src/components/ChatInterface/index.jsx`**
   - 在发送消息时传递用户输入
   - 支持实时关键词检测

3. **`src/App.jsx`**
   - 生子时记录记忆
   - 怀孕时记录记忆
   - 送礼时记录记忆
   - 子女成婚时记录记忆
   - 子女拜师时记录记忆
   - 游戏初始化时批量补录记忆

### 📊 数据结构

```javascript
npc.memories = {
  profile: {
    name: "陆昭",
    personality: "坚韧",
    identity: "落魄散修",
    firstMeet: "2026-01-26T12:00:00Z"
  },
  
  milestones: [
    {
      id: 1738056789123,
      event: "为你生子",
      time: "天元5年春",
      detail: "难产，甚至为此损耗了修为根基，孩子取名张小凡...",
      emotionalImpact: "刻骨铭心",
      category: "family",
      tags: ["生子", "孩子", "张小凡", "牺牲"],
      createdAt: "2026-01-26T12:00:00Z"
    }
  ],
  
  recentEvents: [
    {
      id: 1738056789456,
      description: "收到你赠送的飞剑",
      time: "2026-01-26T12:00:00Z",
      affectionChange: 10,
      context: "玩家正在讨好我"
    }
  ],
  
  longTermSummary: "",
  
  meta: {
    totalEvents: 2,
    lastSummaryTime: null,
    needsSummary: false
  }
}
```

### 🎮 游戏体验提升

#### 对话深度大幅增强

**之前：**
```
玩家: "你后悔吗？"
AI: "我不后悔，修行路本就艰辛。"
```

**现在：**
```
玩家: "你后悔吗？"
AI: "看着小凡一天天长大，当年损耗修为、九死一生的痛，便都不算什么了。"
```

#### 记忆连贯性

- NPC 会记得为你生过孩子
- NPC 会记得你送过什么珍贵礼物
- NPC 会记得你们经历的生死时刻
- NPC 会在对话中自然提及这些往事

### 🔍 调试工具

在浏览器控制台运行：

```javascript
// 测试记忆系统
window.testMemorySystem();

// 查看某个 NPC 的记忆
const npc = gameState.npcs[0];
console.log(npc.memories);
```

### 📈 性能优化

- **Token 控制**: 总计约 2350 Token（里程碑 ~800 + 近期事件 ~600 + 摘要 ~150 + 基础 ~800）
- **内存占用**: 每个 NPC 约增加 2-5KB
- **无性能影响**: 只在构建 Prompt 时拼接字符串，开销可忽略

### ⚠️ 注意事项

1. **不要滥用里程碑**
   - 只记录真正重要的事件
   - 建议每个 NPC ≤ 10 个里程碑

2. **善用事件升级**
   - 普通事件先记录到 recentEvents
   - 真正重要的再升级为 milestone

3. **定期查看记忆**
   - 使用 `MemoryManager.getMemorySummary(npc)` 检查记忆积累
   - 避免重复记录相同事件

### 🚀 下一步优化方向

1. **记忆淡化**：时间越久，情感强度降低
2. **记忆冲突**：如果玩家既伤害过又讨好过，AI 会纠结
3. **记忆共享**：子女能"听说"父母的过往
4. **可视化界面**：在 UI 上展示 NPC 的"回忆录"

---

## 使用示例

### 场景 1：玩家与刚生完孩子的 NPC 对话

```
玩家: "身体还好吗？"

System Prompt 包含:
【刻骨铭心的记忆】
1. **为你生子**（天元5年春）
   为你诞下张小凡，历经生死劫难，甚至为此损耗了修为根基...

AI: "还在恢复中...生产时险些散了根基，但看到小凡健康，我便心安了。"
```

### 场景 2：多年后再提起

```
玩家: "还记得小凡出生那天吗？"

关键词: ['孩子', '小凡']
→ 唤起相关记忆

AI: "怎会忘记...那是我这辈子最痛也最幸福的一天。"
```

### 场景 3：询问是否后悔

```
玩家: "你觉得值得吗？"

关键词: ['值得']
→ 添加指令: "请结合过往经历真诚回应"

AI: "当年为你损耗修为之时，我未曾犹豫。如今看你我子女成才，这点代价又算得了什么？"
```

---

## 开发者备注

### Token 预算分析

| 组件 | Token 估算 |
|------|-----------|
| 基础人设 | ~800 |
| 里程碑记忆（10个） | ~800 |
| 近期事件（5条） | ~150 |
| 长期摘要 | ~150 |
| 关键词触发指令 | ~100 |
| **总计** | **~2000** |

在 4k-8k context window 内完全可控。

### 兼容性

- ✅ 兼容现有存档（自动补录）
- ✅ 兼容旧的 eventHistory 系统
- ✅ 不影响现有游戏逻辑

---

## 致谢

这是一个非常高级且能触动人心的功能。通过**上下文管理**，我们让 LLM 拥有了"记忆"，让对话不再是空洞的客套话，而是带着真实经历的深情回应。

**当玩家问"你后悔吗？"时，AI 不会只说"不后悔"，而是会回忆起具体的细节：**

> "看着我们的孩儿一天天长大，当年的痛，便都不算什么了。"

这就是记忆宫殿的力量。🌟
