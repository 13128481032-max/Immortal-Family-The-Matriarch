# 🎲 剧情触发概率详解

## 📊 总体概率分配

当玩家点击"闲聊"按钮时：

```
┌─────────────────────────────────────┐
│  整体分布（100%）                    │
├─────────────────────────────────────┤
│  ████████████████████ 70-85%       │ → 普通闲聊（一句话）
│  ████████ 15-30%                   │ → 专属事件
└─────────────────────────────────────┘
```

---

## 🎯 详细触发流程

### 一、子女互动（NPC.isChild = true）

```
点击"闲聊"
    │
    ├─ 25% → 触发亲情专属剧情（根据年龄段）
    │         ├─ 0-10岁：幼年剧情（5条随机1）
    │         ├─ 11-18岁：少年剧情（5条随机1）
    │         └─ 18岁+：成年剧情（5条随机1）
    │
    └─ 75% → 普通闲聊（一句话）
```

**好感度加成**：
- 亲情剧情：+4 ~ +15
- 普通闲聊：+2

---

### 二、成年 NPC 互动（NPC.isChild = false）

#### 第一阶段：专属事件判定（30%）

```
点击"闲聊"
    │
    ├─ 30% → 进入专属事件池
    │         │
    │         ├─ 好感度 ≥ 80（热恋期）
    │         │   ├─ 70% → 浪漫剧情（根据性格）
    │         │   └─ 30% → 身份专属剧情
    │         │
    │         ├─ 好感度 60-79（暧昧期）
    │         │   ├─ 50% → 浪漫剧情（根据性格）
    │         │   └─ 50% → 身份专属剧情
    │         │
    │         └─ 好感度 < 60（陌生/友好）
    │             └─ 100% → 身份专属剧情
    │
    └─ 70% → 进入普通互动池（继续往下判定）
```

#### 第二阶段：选项事件判定（15%）

```
未触发专属事件（70%的人）
    │
    ├─ 15% → 触发选项事件（带选择的复杂事件）
    │
    └─ 85% → 普通闲聊（一句话）
```

---

## 📈 综合概率计算

### 案例1：低好感度 NPC（好感 < 60）

```
身份：剑修传人 | 性格：高冷 | 好感度：30

触发概率：
├─ 身份专属剧情（论剑、赠剑等）：30%
├─ 选项事件：10.5% (70% × 15%)
└─ 普通闲聊：59.5% (70% × 85%)
```

### 案例2：中等好感度 NPC（好感 60-79）

```
身份：丹道奇才 | 性格：温柔 | 好感度：70

触发概率：
├─ 浪漫剧情（晨起、赠礼等）：15% (30% × 50%)
├─ 身份专属剧情（炼丹、采药等）：15% (30% × 50%)
├─ 选项事件：10.5% (70% × 15%)
└─ 普通闲聊：59.5% (70% × 85%)
```

### 案例3：高好感度 NPC（好感 ≥ 80）

```
身份：魔教护法 | 性格：病娇 | 好感度：85

触发概率：
├─ 浪漫剧情（吃醋、对视等）：21% (30% × 70%)
├─ 身份专属剧情（魔功反噬、血契等）：9% (30% × 30%)
├─ 选项事件：10.5% (70% × 15%)
└─ 普通闲聊：59.5% (70% × 85%)
```

### 案例4：子女（任意好感度）

```
身份：继承人 | 年龄：15岁 | 好感度：60

触发概率：
├─ 亲情剧情（少年期）：25%
└─ 普通闲聊：75%
```

---

## 🎭 性格与浪漫剧情对应表

| 性格标签 | 触发的浪漫剧情风格 | 剧情示例 |
|---------|------------------|---------|
| 高冷、清冷、禁欲、冷淡 | 冰山系（5条） | 疗伤、传道、醉酒、深夜独处、共渡心魔 |
| 病娇、偏执、疯批、执念 | 占有系（5条） | 吃醋、对视、索取、标记、囚禁威胁 |
| 温柔、温润、忠犬、深情、坚韧 | 温柔系（5条） | 晨起、赠礼、承诺、披衣、受伤代价 |
| 风流、魅惑、浪荡、妖媚 | 魅惑系（5条） | 调笑、共浴、品酒、抚琴、夜访 |
| 其他性格 | 温柔系（默认） | 同上 |

---

## 🏛️ 身份与专属剧情对应表

| 身份 | 专属剧情数量 | 剧情示例 |
|------|------------|---------|
| 剑修传人 | 3条 | 论剑、赠剑、剑心共鸣 |
| 丹道奇才 | 3条 | 炼丹失败、赠丹、采药之行 |
| 魔教护法 / 血海魔君 | 3条 | 魔功反噬、血契、月下魔音 |
| 佛修 | 3条 | 传经、破戒边缘、舍利相赠 |
| 妖族半妖 | 3条 | 兽性爆发、化形之难、妖丹相护 |
| 医修圣手 | 3条 | 诊脉、救人、温泉疗养 |
| 音修琴者 | 3条 | 抚琴、琴心共鸣、琴弦断裂 |
| 其他身份 | 无 | 无专属剧情，只触发性格对话 |

---

## 💡 触发建议

### 想快速提升好感度？
- **策略**：多次闲聊
- **预期**：大部分时候 +2，偶尔触发专属剧情 +5~15
- **适用**：前期刷好感

### 想体验丰富剧情？
- **策略**：将好感度提升到 60+
- **预期**：30%概率触发浪漫或身份专属剧情
- **适用**：中后期享受剧情

### 想体验特定类型剧情？
- **浪漫剧情**：好感度 ≥ 80，多次闲聊
- **身份专属**：好感度 < 60，选择特定身份的NPC
- **亲情剧情**：与子女互动，25%概率触发

---

## 📊 期望值计算

### 场景：连续闲聊10次

#### 低好感度 NPC（好感 30）
```
预期结果：
- 身份专属剧情：3次（平均 +6×3 = +18）
- 选项事件：1次（需要选择）
- 普通闲聊：6次（+2×6 = +12）

总好感度提升：约 +30 ~ +40
```

#### 高好感度 NPC（好感 85）
```
预期结果：
- 浪漫剧情：2次（平均 +8×2 = +16）
- 身份专属剧情：1次（+6）
- 选项事件：1次（需要选择）
- 普通闲聊：6次（+2×6 = +12）

总好感度提升：约 +34 ~ +45
```

#### 子女
```
预期结果：
- 亲情剧情：2-3次（平均 +8×2.5 = +20）
- 普通闲聊：7-8次（+2×7.5 = +15）

总好感度提升：约 +35
```

---

## 🎯 设计理念

### 为什么大概率是普通闲聊？

1. **避免审美疲劳**：专属剧情太频繁会失去特殊感
2. **保持期待感**：偶尔触发的惊喜更有价值
3. **符合现实**：日常互动中，深入交流本就少见
4. **平衡游戏节奏**：不让玩家每次都要读大段文字

### 为什么好感度越高，浪漫剧情越多？

1. **符合恋爱逻辑**：关系越深，亲密互动越频繁
2. **奖励玩家投入**：高好感是努力的结果，应该给予更好的体验
3. **推动剧情发展**：从陌生到熟悉到恋爱，剧情自然进阶

### 为什么子女剧情概率较低？

1. **亲情更纯粹**：不需要频繁的戏剧性场景
2. **留白空间**：给玩家自己想象的空间
3. **避免单调**：子女剧情类型有限，低频更珍贵

---

## 🔧 技术实现

### 代码位置
- **触发逻辑**：`src/game/textEngine.js` → `getUnifiedInteractionEvent()`
- **调用入口**：`src/App.jsx` → `handleNpcInteract()` → `CHAT`

### 核心算法
```javascript
// 第一层：30%专属事件
if (Math.random() < 0.3) {
  // 根据好感度分配浪漫/身份专属
  if (affection >= 80) return 70%浪漫 + 30%身份;
  if (affection >= 60) return 50%浪漫 + 50%身份;
  return 100%身份;
}

// 第二层：15%选项事件
if (Math.random() < 0.15) return 选项事件;

// 第三层：普通闲聊
return 普通闲聊;
```

---

## ✨ 总结

这套概率系统确保了：
- ✅ **大概率**（70-85%）触发简短、轻松的一句话闲聊
- ✅ **小概率**（15-30%）触发丰富、深入的专属剧情
- ✅ **好感度越高**，浪漫剧情占比越大
- ✅ **每个身份、性格**都有对应的专属剧情路径
- ✅ **子女、伴侣、陌生人**有不同的互动体验

这样既保证了日常互动的流畅性，又让专属剧情成为惊喜彩蛋！🎉
