# NPC 第一人称动态日志系统更新日志

## 版本：v1.0.0
**更新日期**：2026年1月26日

---

## 📖 功能概述

实现了一个完整的 **NPC 第一人称动态日志系统**，让每个 NPC 拥有自己的"生活日记本"，记录他们的日常、心情、与玩家的互动等。这极大地提升了游戏的"鲜活感"，使 NPC 不再是等待点击的数据包，而是有了自己生活轨迹的"活人"。

---

## ✨ 核心特性

### 1. 数据结构
- 为每个 NPC 对象新增 `logs` 数组字段
- 每条日志包含：
  - `year`: 年份
  - `month`: 月份
  - `content`: 日志内容（第一人称）
  - `type`: 日志类型（INTERACTION/STATE_CHANGE/DAILY/EVENT）
  - `isSecret`: 是否私密（需高好感度查看）
  - `timestamp`: 时间戳（用于排序和去重）

### 2. 日志类型

#### 📝 交互日志（INTERACTION）
当玩家与 NPC 互动时立即生成：
- **闲聊**：根据好感度不同，NPC 的心理活动也不同
  - 低好感：冷淡应付
  - 中好感：感觉愉快
  - 高好感：依依不舍、心动等
  
- **赠礼**：区分喜欢和讨厌
  - 喜欢：欢喜、感动、窃喜
  - 讨厌：生气、尴尬、疑惑

- **切磋**：记录胜负和内心感受
  - 胜利：认可对方实力、获得启发
  - 失败：不甘心、决心变强、心跳加速（暗恋）

- **双修**：私密日志，需高好感查看

#### ⚡ 重大状态变更日志（STATE_CHANGE）
生命中的重大事件：
- **突破成功**：激动、感慨、立志
- **突破失败**：挫折、反思、疗伤
- **结婚**：承诺、温馨、幸福
- **生子**：责任、期望、父爱/母爱
- **寿元将尽**：回忆、遗憾、放不下
- **受重伤**：恐惧、痛苦、感激救命恩人

#### 📖 日常模拟日志（DAILY）
根据身份、性格、关系动态生成：

**按身份分类**：
- 宗门天骄：苦练剑法、宗门大比、师父传授
- 剑修传人：练剑悟道、心中杂念
- 丹道奇才：炼丹、采购药材、炸炉
- 落魄散修：缺灵石、接任务、逃命
- 佛修：诵经、禅定、讲经说法
- 凡间书生：科举、听江湖事、渴望修仙

**按性格分类**：
- 高冷：独坐观云、拒人千里
- 温柔：采药送人、帮助他人
- 傲娇：口是心非、担心却不承认
- 病娇：偷偷跟踪、占有欲、杀意
- 正直：见义勇为、坚持原则
- 活泼：恶作剧、下山玩耍、开心

**按关系状态分类**：
- 陌生：不提玩家，只记录自己的事
- 暗恋（高好感）：想念玩家、认错背影、梦到玩家
- 仇恨：发誓报复、刻苦修炼
- 道侣：温馨日常、为对方煲汤、等待归来

### 3. 智能生成机制

#### 权重随机算法
系统根据 NPC 的多种属性动态调整生成权重：
- **关系权重**：好感度越高，越容易在日志中提及玩家
  - 道侣：60% 提及玩家
  - 暗恋（80+ 好感）：40% 提及
  - 陌生（<20 好感）：0% 提及

- **身份权重**：30% - 根据职业生成对应活动
- **性格权重**：20% - 体现性格特点
- **特殊事件**：15% - 宗门任务、探险、购物等
- **通用场景**：35% - 天气、景色、发呆

#### 防重复机制
- 标记本月已生成日志的 NPC，避免重复生成
- 交互后立即标记，月末只为未标记的 NPC 生成日常日志

#### 存储优化
- 每个 NPC 最多保留 50 条日志
- 超过限制自动删除最旧的记录
- 防止存档文件过大

### 4. 隐私系统
- **公开日志**：所有人都能看到
- **私密日志**（🔒标记）：需要好感度 ≥ 80 才能查看
  - 暗恋心事
  - 双修记录
  - 病娇的黑化想法
  - 临终遗憾

### 5. UI 展示

#### 日志查看界面
- **筛选功能**：全部/互动/大事/日常
- **时间轴展示**：按时间倒序排列
- **类型标识**：
  - 💬 互动（绿色）
  - ⚡ 大事（红色）
  - 📖 日常（蓝色）
- **私密提示**：🔒 图标 + 好感度提醒
- **精美样式**：渐变背景、悬浮效果、动画

#### 入口
- 在 NPC 详情页面底部添加"📖 查看 XX 的日志"按钮
- 点击后弹出独立的日志查看模态框

---

## 🗂️ 文件结构

```
src/
├── data/
│   └── logTemplates.js          # 日志文本模板库（1000+ 行）
├── game/
│   └── npcLogSystem.js          # 日志生成引擎（核心逻辑）
├── components/
│   └── Modals/
│       ├── NpcLogModal.jsx      # 日志查看 UI 组件
│       └── NpcLogModal.css      # 日志样式
└── App.jsx                       # 集成到主游戏逻辑
```

---

## 🔧 技术实现

### 1. 文本模板系统（logTemplates.js）
- 300+ 条精心编写的第一人称文本模板
- 支持占位符替换：`{playerName}`、`{gender_ta}`、`{giftName}` 等
- 分类清晰，易于扩展

### 2. 日志生成引擎（npcLogSystem.js）
核心函数：
- `generateChatLog()` - 生成闲聊日志
- `generateGiftLog()` - 生成赠礼日志
- `generateSparLog()` - 生成切磋日志
- `generateDualCultivationLog()` - 生成双修日志
- `generateBreakthroughLog()` - 生成突破日志
- `generateMarriageLog()` - 生成结婚日志
- `generateChildbornLog()` - 生成生子日志
- `generateDailyLog()` - 生成日常日志（核心，最复杂）
- `generateMonthlyLogsForAll()` - 批量为所有 NPC 生成月度日志

辅助函数：
- `addNpcLog()` - 添加日志并自动清理旧数据
- `markNpcLoggedThisMonth()` - 标记已生成日志
- `getVisibleLogs()` - 根据好感度过滤私密日志
- `getLogsByTimeRange()` - 按时间范围查询
- `getLogsByType()` - 按类型查询

### 3. 集成点

#### 时间推进（handleNextMonth）
```javascript
// 在每月推进时，为所有 NPC 生成日志
setActiveNpcs(prev => {
  const nextYear = player.time.month === 12 ? player.time.year + 1 : player.time.year;
  const nextMonth = player.time.month === 12 ? 1 : player.time.month + 1;
  return generateMonthlyLogsForAll(prev, player, nextYear, nextMonth);
});
```

#### 玩家交互（闲聊、赠礼）
```javascript
// 交互后立即生成日志并标记
let updated = generateChatLog(n, player, year, month);
updated = markNpcLoggedThisMonth(updated);
```

---

## 💡 设计亮点

### 1. 真实感营造
- **第一人称叙事**：完全从 NPC 视角，而非系统提示
  - ❌ "NPC 好感度 +2"
  - ✅ "今日与XX攀谈，觉得此人言谈风趣，或许可以深交"

### 2. 情感深度
- 根据关系发展，日志内容逐渐变化
- 从陌生→熟悉→暗恋→道侣，每个阶段有不同的心理描写

### 3. 细节丰富
- 性格影响：病娇会在日志中透露黑化想法
- 身份影响：散修担心灵石，宗门天骄自我鞭策
- 随机性：同一类型有多个模板，避免重复

### 4. 玩家参与感
- 通过日志"偷窥" NPC 的内心世界
- 高好感解锁私密日志，形成正反馈
- 无意中的巧合（如 NPC 日志提到想要某物，玩家下月送了）带来惊喜

---

## 📊 数据示例

### 示例 1：高冷剑修的日志时间线
```
[天元 5年 3月] 💬 互动
今日练剑三千次，心神不宁。师父说我心中有杂念，难道是因为上次欠了XX的人情未还？

[天元 5年 2月] 📖 日常
宗门大比，险胜李师弟。他的剑法精进很快，我不可懈怠。

[天元 5年 1月] 📖 日常
下山除妖，路过凡人村落，见炊烟升起，竟有些羡慕这短暂的安宁。

[天元 4年 12月] 💬 互动
与XX切磋。他的身法很诡异，我输了半招。虽不甘心，但……确实痛快。
```

### 示例 2：温柔女修的暗恋日志（🔒 需 80+ 好感）
```
[天元 5年 5月] 🔒 私密
今日在坊市远远看到一个背影很像XX，追上去却认错人了，怅然若失。

[天元 5年 4月] 🔒 私密
梦到XX了...醒来后却是空荡荡的房间，有些失落。

[天元 5年 3月] 📖 日常
今日炼了一炉丹药，想着下次见到XX时送给他。
```

---

## 🎯 未来扩展方向

### 1. 更多事件类型
- 宗门任务完成
- 遭遇危险
- 拍卖会购物
- 结识新朋友

### 2. NPC 间互动日志
- "今日与李师兄切磋，他的剑法又精进了"
- "听说XX和YY在一起了，真是般配"

### 3. 季节/节日特殊日志
- 春节：思乡、团圆
- 中秋：赏月、孤独
- 冬至：闭关、修炼

### 4. 导出/分享功能
- 将 NPC 日志导出为文本文件
- 生成"修仙日记"供玩家收藏

---

## 🐛 已知问题与注意事项

### 1. 性能考虑
- 每月为所有 NPC 生成日志，NPC 数量过多时可能有延迟
- 建议控制活跃 NPC 数量在 50 以内

### 2. 存档兼容性
- 旧存档的 NPC 没有 `logs` 字段
- 系统会自动初始化为空数组，不会报错
- 从旧存档加载后，NPC 会从当前月开始记录日志

### 3. 文本质量
- 部分模板可能出现重复
- 后续可以通过社区征集更多文本

---

## 📝 致谢

感谢原需求提供者对游戏"鲜活感"的深刻理解。这个系统的设计理念来源于：
> "NPC 不应该是等待玩家点击的数据包，而应该是有自己生活轨迹的'活人'"

这个理念贯穿了整个系统的实现。

---

## 🎮 使用方法

### 玩家操作
1. 进入游戏后，与任意 NPC 互动（闲聊、赠礼等）
2. 打开 NPC 详情页面
3. 点击底部的"📖 查看 XX 的日志"按钮
4. 在日志界面可以：
   - 查看全部日志
   - 按类型筛选（互动/大事/日常）
   - 提升好感度解锁私密日志

### 开发者扩展
如需添加新的日志模板：
1. 打开 `src/data/logTemplates.js`
2. 在对应的数组中添加新文本
3. 使用占位符 `{playerName}` `{gender_ta}` 等
4. 保存即可，系统会自动随机选择

---

**版本：v1.0.0 | 最后更新：2026年1月26日**
